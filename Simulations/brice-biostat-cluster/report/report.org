#+TITLE: Results simulation study DelayedGSD
#+Author: 

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Path
if(Sys.info()["login"] == "bozenne"){
}else if(Sys.info()["login"] == "hpl802"){
  setwd("x:/DelayedGSD/")
}

options(width = 120, digits = 4)

library(data.table)
library(ggplot2)
library(xtable)

dec2pc <- function(x, digits = 2){
  ## dec2pc(c(1/3,1/4,1/5,1/10,1/100,1/200,1/2000,1/20000,0))
  out <- paste0(formatC(100*x, format='f', digits = digits), "%")
  if(any(round(100*x,digits)==0)){
    out[round(100*x,digits)==0] <- paste0("<0.",rep(0,digits-1),"1%")
  }
  if(any(abs(x)<1e-12)){
    out[abs(x)<1e-12] <- "0"
  }
  return(out)
}

mean2pc <- function(x, digits = 2){
  out <- dec2pc(mean(x, na.rm = TRUE), digits = digits)
  if(any(is.na(x))){
    out <- paste0(out," (NA: ",dec2pc(mean(is.na(x)), digits = digits),")")
  }
  return(out)
}
ciNA <- function(x, digits = 4){
  if(all(is.na(x))){
    out <- as.character(NA)
  }else if(any(is.na(x))){
    out <- paste0("[",round(min(x, na.rm = TRUE), digits = digits),
                  ";",round(max(x, na.rm = TRUE), digits = digits),
                  "] NA = ",sum(is.na(x)))
  }else{
    out <- paste0("[",round(min(x), digits = digits),
                  ";",round(max(x), digits = digits),
                  "]")
  }
  return(out)
}
#+END_SRC

#+RESULTS:


#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Load results
res2stage <- readRDS(file.path("Results-built","res2stage.rds"))
res2stage[, method.char := paste0("method ",method)]
res2stage[, stage.char := factor(stage, 1:2, c("interim","final"))]
res2stage[, truth := ifelse(hypo=="power",0.6,0)]
#+END_SRC

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Load results
res3stage <- readRDS(file.path("Results-built","res3stage.rds"))
res3stage[, method.char := paste0("method ",method)]
res3stage[, stage.char := factor(stage, 1:3, c("interim 1","interim 2","final"))]
res3stage[, truth := ifelse(hypo=="power",0.6,0)]
#+END_SRC

#+RESULTS:


* Overview scenario :noexport:

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
dir.2stage.output <- gsub("Results","output",dir.2stage)
ls.2stage.output1 <- lapply(dir.2stage.output, function(iDir){readLines(file.path(iDir,list.files(iDir)[1]))})
vec.2stage.lineSample <- sapply(ls.2stage.output1, function(iOut){iOut[grepl("^Sample size:",iOut, fixed = FALSE)]})
M.2stage.sampleSize <- do.call(rbind,lapply(lapply(strsplit(gsub("Sample size: ","",vec.2stage.lineSample), split = ","),trimws),as.numeric))
df.2stage.sampleSize <- data.frame(file = gsub("x:/DelayedGSD/output/2stage_","",dir.2stage.output), sample.size = M.2stage.sampleSize[,1])

dir.3stage.output <- gsub("Results","output",dir.3stage)
ls.3stage.output1 <- lapply(dir.3stage.output, function(iDir){readLines(file.path(iDir,list.files(iDir)[1]))})
vec.3stage.lineSample <- sapply(ls.3stage.output1, function(iOut){iOut[grepl("^Sample size:",iOut, fixed = FALSE)]})
M.3stage.sampleSize <- do.call(rbind,lapply(lapply(strsplit(gsub("Sample size: ","",vec.3stage.lineSample), split = ","),trimws),as.numeric))
df.3stage.sampleSize <- data.frame(file = gsub("x:/DelayedGSD/output/3stage_","",dir.3stage.output), sample.size = M.3stage.sampleSize[,1])

df.stage.sampleSize <- merge(df.2stage.sampleSize,df.3stage.sampleSize, by = "file")
df.stage.sampleSize$sample.size <- paste(df.stage.sampleSize$sample.size.x,df.stage.sampleSize$sample.size.y,sep="/")
#+END_SRC

#+RESULTS:

#+BEGIN_SRC R :exports both :results output :session *R* :cache no
Uscenario2 <- res2stage[,.(file=gsub("^sim-2stage_|-1_100.rds$","",file[1])), by = c("scenario","missing","binding","fixC","ar","hypo")]
Uscenario2[, missing := c("No","Yes")[missing+1]]
Uscenario2[, binding := c("No","Yes")[binding+1]]
Uscenario2[, fixC := c("No","Yes")[fixC+1]]
Uscenario2[, hypo := c(0,0.6)[(hypo=="power")+1]]

Uscenario2print <- merge(Uscenario2, df.stage.sampleSize[,c("file","sample.size")], by = "file")
Uscenario2print[, sample.size := as.character(round(sample.size,0))]
Uscenario2print[, ar := as.character(round(ar,0))]
print(xtable(Uscenario2print[,.(scenario,sample.size,missing,binding,fixC,ar,hypo)]), include.rownames = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
Fejl i round(sample.size, 0) : 
  non-numeric argument to mathematical function
% latex table generated in R 4.2.0 by xtable 1.8-4 package
% Thu Oct 12 17:06:00 2023
\begin{table}[ht]
\centering
\begin{tabular}{rlllllr}
  \hline
scenario & sample.size & missing & binding & fixC & ar & hypo \\ 
  \hline
  1 & 549/553 & Yes & Yes & No & 10 & 0.60 \\ 
    2 & 549/553 & Yes & Yes & No & 10 & 0.00 \\ 
    3 & 549/553 & Yes & Yes & No & 5 & 0.60 \\ 
    4 & 549/553 & Yes & Yes & No & 5 & 0.00 \\ 
    5 & 549/553 & Yes & Yes & Yes & 10 & 0.60 \\ 
    6 & 549/553 & Yes & Yes & Yes & 10 & 0.00 \\ 
    7 & 549/553 & Yes & Yes & Yes & 5 & 0.60 \\ 
    8 & 549/553 & Yes & Yes & Yes & 5 & 0.00 \\ 
    9 & 557/563 & Yes & No & Yes & 10 & 0.60 \\ 
   10 & 557/563 & Yes & No & Yes & 10 & 0.00 \\ 
   11 & 557/563 & Yes & No & Yes & 5 & 0.60 \\ 
   12 & 557/563 & Yes & No & Yes & 5 & 0.00 \\ 
   13 & 557/563 & Yes & No & No & 10 & 0.60 \\ 
   14 & 557/563 & Yes & No & No & 10 & 0.00 \\ 
   15 & 557/563 & Yes & No & No & 5 & 0.60 \\ 
   16 & 557/563 & Yes & No & No & 5 & 0.00 \\ 
   17 & 491/500 & No & Yes & No & 5 & 0.60 \\ 
   18 & 491/500 & No & Yes & No & 5 & 0.00 \\ 
   \hline
\end{tabular}
\end{table}
#+end_example

* Rejection rate

** 2 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## For each run, create a binary indicator for rejection for efficacy
res2stage.rejection <- res2stage[,.(n.stage = .N, rejection = "efficacy" %in% na.omit(decision)),
                                 by = c("method.char","seed","scenario","missing","binding","fixC","ar","hypo")]

## Average over runs and method within scenario
res2stageS.rejection <- res2stage.rejection[,.(n.sim = .N, rejectionRate = dec2pc(mean(rejection))),
                                            by=c("method.char","scenario","binding","missing","fixC","ar","hypo")]
#+END_SRC

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
# average power with method 1
res2stage.rejection[hypo == "power" & method.char == "method 1", 100*mean(rejection),by = "scenario"][,mean(V1)]
#+END_SRC

#+RESULTS:
: [1] 80.3

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## difference between methods
res2stageS2.rejection <- res2stage.rejection[hypo == "power", mean(rejection),by = c("method.char","scenario")]
res2stageL2.rejection <- dcast(res2stageS2.rejection, scenario ~ method.char, value.var = "V1")
100*range(res2stageL2.rejection[["method 2"]] - res2stageL2.rejection[["method 1"]])
100*range(res2stageL2.rejection[["method 3"]] - res2stageL2.rejection[["method 1"]])
#+END_SRC

#+RESULTS:
: [1] -0.07  0.26
: [1] -0.57  0.40

Power by method (columns) and scenario (rows): \hfill (nominal level 80%)
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
table2stage.PrintH1 <- dcast(res2stageS.rejection[hypo=="power"],
                      scenario + n.sim + missing + binding + fixC + ar ~ method.char,
                      value.var = "rejectionRate")
print(table2stage.PrintH1, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario n.sim missing binding  fixC ar method 1 method 2 method 3
        1 10000    TRUE    TRUE FALSE 10   81.00%   80.93%   80.43%
        3 10000    TRUE    TRUE FALSE  5   80.53%   80.53%   80.14%
        5 10000    TRUE    TRUE  TRUE 10   80.15%   80.35%   80.43%
        7 10000    TRUE    TRUE  TRUE  5   80.08%   80.20%   80.14%
        9 10000    TRUE   FALSE  TRUE 10   79.86%   80.12%   80.26%
       11 10000    TRUE   FALSE  TRUE  5   79.93%   80.04%   80.06%
       13 10000    TRUE   FALSE FALSE 10   80.50%   80.44%   80.26%
       15 10000    TRUE   FALSE FALSE  5   80.37%   80.36%   80.06%
       17 10000   FALSE    TRUE FALSE  5   80.31%   80.30%   79.92%
#+end_example

\bigskip

Type 1 error by method (columns) and scenario (rows): \hfill (nominal level 2.5%)
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
table2stage.PrintH0 <- dcast(res2stageS.rejection[hypo=="typeI"],
                      scenario + n.sim + missing + binding + fixC + ar ~ method.char,
                      value.var = "rejectionRate")
print(table2stage.PrintH0, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario n.sim missing binding  fixC ar method 1 method 2 method 3
        2 10000    TRUE    TRUE FALSE 10    2.42%    2.39%    2.37%
        4 10000    TRUE    TRUE FALSE  5    2.40%    2.40%    2.35%
        6 10000    TRUE    TRUE  TRUE 10    2.24%    2.22%    2.37%
        8 10000    TRUE    TRUE  TRUE  5    2.32%    2.31%    2.35%
       10 10000    TRUE   FALSE  TRUE 10    2.45%    2.47%    2.57%
       12 10000    TRUE   FALSE  TRUE  5    2.63%    2.64%    2.66%
       14 10000    TRUE   FALSE FALSE 10    2.53%    2.53%    2.57%
       16 10000    TRUE   FALSE FALSE  5    2.68%    2.68%    2.66%
       18 10000   FALSE    TRUE FALSE  5    2.46%    2.46%    2.45%
#+end_example

\clearpage

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Distribution of the p-value:
gg2stage.P <- ggplot(res2stage[hypo == "typeI"]) + facet_grid(scenario~method.char)
gg2stage.P <- gg2stage.P + geom_density(alpha=0.25, aes(x = p.value_ML, fill = "Naive"))
gg2stage.P <- gg2stage.P + geom_density(alpha=0.25, aes(x = p.value_MUE, fill = "Adjusted"))
gg2stage.P <- gg2stage.P + labs(fill = "P-value", x = "Estimate", y = "Density")
gg2stage.P <- gg2stage.P + theme(text = element_text(size=15), 
                     axis.line = element_line(linewidth = 1.25),
                     axis.ticks = element_line(linewidth = 2),
                     axis.ticks.length=unit(.25, "cm"),
                     legend.key.size = unit(3,"line"))
ggsave(gg2stage.P, filename = file.path("report","figures","gg2stage-pvalue-density.pdf"), height = 10, width = 12)
#+END_SRC

#+RESULTS:
: Advarselsbeskeder:
: 1: [1m[22mRemoved 375681 rows containing non-finite values (`stat_density()`). 
: 2: [1m[22mRemoved 375681 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and adjusted p-value distribution over all simulations under the null. Each row correspond to a different scenario
[[./figures/gg2stage-pvalue-density.pdf]]

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
gg2stage.P2 <- ggplot(res2stage[hypo == "power"]) + facet_grid(scenario~method.char)
gg2stage.P2 <- gg2stage.P2 + geom_density(alpha=0.25, aes(x = p.value_ML, fill = "Naive"))
gg2stage.P2 <- gg2stage.P2 + geom_density(alpha=0.25, aes(x = p.value_MUE, fill = "Adjusted"))
gg2stage.P2 <- gg2stage.P2 + labs(fill = "P-value", x = "Estimate", y = "Density")
gg2stage.P2 <- gg2stage.P2 + coord_cartesian(xlim = c(0,0.05))
gg2stage.P2 <- gg2stage.P2 + theme(text = element_text(size=15), 
                     axis.line = element_line(linewidth = 1.25),
                     axis.ticks = element_line(linewidth = 2),
                     axis.ticks.length=unit(.25, "cm"),
                     legend.key.size = unit(3,"line"))
ggsave(gg2stage.P2, filename = file.path("report","figures","gg2stage-pvalue2-density.pdf"), height = 10, width = 12)
#+END_SRC

#+RESULTS:
: Advarselsbeskeder:
: 1: [1m[22mRemoved 386959 rows containing non-finite values (`stat_density()`). 
: 2: [1m[22mRemoved 386959 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and adjusted p-value distribution over all simulations under the alternative. Each row correspond to a different scenario
[[./figures/gg2stage-pvalue2-density.pdf]]

\clearpage

** 3 stages

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## For each run, create a binary indicator for rejection for efficacy
res3stage.rejection <- res3stage[,.(n.stage = .N, rejection = "efficacy" %in% na.omit(decision)),
                                 by = c("method.char","seed","scenario","missing","binding","fixC","ar","hypo")]

## Average over runs and method within scenario
res3stageS.rejection <- res3stage.rejection[,.(n.sim = .N, rejectionRate = dec2pc(mean(rejection))),
                                            by=c("method.char","scenario","binding","missing","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:

Power by method (columns) and scenario (rows): \hfill (nominal level 80%)
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
table3stage.PrintH1 <- dcast(res3stageS.rejection[hypo=="power"],
                             scenario + n.sim + missing + binding + fixC + ar ~ method.char,
                             value.var = "rejectionRate")
print(table3stage.PrintH1, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario n.sim missing binding  fixC ar method 1 method 2 method 3
        1 10000    TRUE    TRUE FALSE 10   74.51%   74.51%   74.01%
        3 10000    TRUE    TRUE FALSE  5   74.35%   74.35%   73.99%
        5 10000    TRUE    TRUE  TRUE 10   73.84%   73.91%   74.01%
        7 10000    TRUE    TRUE  TRUE  5   74.00%   74.01%   73.99%
        9 10000    TRUE   FALSE  TRUE 10   74.17%   74.25%   74.45%
       11 10000    TRUE   FALSE  TRUE  5   74.33%   74.37%   74.43%
       13 10000    TRUE   FALSE FALSE 10   74.71%   74.71%   74.45%
       15 10000    TRUE   FALSE FALSE  5   74.61%   74.59%   74.43%
       17 10000   FALSE    TRUE FALSE  5   72.18%   72.18%   71.97%
#+end_example

\bigskip

Type 1 error by method (columns) and scenario (rows): \hfill (nominal level 2.5%)
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
table3stage.PrintH0 <- dcast(res3stageS.rejection[hypo=="typeI"],
                             scenario + n.sim + missing + binding + fixC + ar ~ method.char,
                             value.var = "rejectionRate")
print(table3stage.PrintH0, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario n.sim missing binding  fixC ar method 1 method 2 method 3
        2 10000    TRUE    TRUE FALSE 10    2.60%    2.60%    2.49%
        4 10000    TRUE    TRUE FALSE  5    2.61%    2.61%    2.59%
        6 10000    TRUE    TRUE  TRUE 10    2.47%    2.50%    2.49%
        8 10000    TRUE    TRUE  TRUE  5    2.56%    2.55%    2.59%
       10  9990    TRUE   FALSE  TRUE 10    2.37%    2.37%    2.42%
       12 10000    TRUE   FALSE  TRUE  5    2.43%    2.44%    2.44%
       14  9990    TRUE   FALSE FALSE 10    2.49%    2.49%    2.42%
       16 10000    TRUE   FALSE FALSE  5    2.53%    2.53%    2.44%
       18 10000   FALSE    TRUE FALSE  5    2.61%    2.61%    2.54%
#+end_example

\clearpage

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Distribution of the p-value:
gg3stage.P <- ggplot(res3stage[hypo == "typeI"]) + facet_grid(scenario~method.char)
gg3stage.P <- gg3stage.P + geom_density(alpha=0.25, aes(x = p.value_ML, fill = "Naive"))
gg3stage.P <- gg3stage.P + geom_density(alpha=0.25, aes(x = p.value_MUE, fill = "Adjusted"))
gg3stage.P <- gg3stage.P + labs(fill = "P-value", x = "Estimate", y = "Density")
gg3stage.P <- gg3stage.P + theme(text = element_text(size=15), 
                     axis.line = element_line(linewidth = 1.25),
                     axis.ticks = element_line(linewidth = 2),
                     axis.ticks.length=unit(.25, "cm"),
                     legend.key.size = unit(3,"line"))
ggsave(gg3stage.P, filename = file.path("report","figures","gg3stage-pvalue-density.pdf"), height = 10, width = 12)
#+END_SRC

#+RESULTS:
: Advarselsbeskeder:
: 1: [1m[22mRemoved 447449 rows containing non-finite values (`stat_density()`). 
: 2: [1m[22mRemoved 447449 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and adjusted p-value distribution over all simulations under the null. Each row correspond to a different scenario
[[./figures/gg3stage-pvalue-density.pdf]]

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
gg3stage.P2 <- ggplot(res3stage[hypo == "power"]) + facet_grid(scenario~method.char)
gg3stage.P2 <- gg3stage.P2 + geom_density(alpha=0.25, aes(x = p.value_ML, fill = "Naive"))
gg3stage.P2 <- gg3stage.P2 + geom_density(alpha=0.25, aes(x = p.value_MUE, fill = "Adjusted"))
gg3stage.P2 <- gg3stage.P2 + labs(fill = "P-value", x = "Estimate", y = "Density")
gg3stage.P2 <- gg3stage.P2 + coord_cartesian(xlim = c(0,0.05))
gg3stage.P2 <- gg3stage.P2 + theme(text = element_text(size=15), 
                     axis.line = element_line(linewidth = 1.25),
                     axis.ticks = element_line(linewidth = 2),
                     axis.ticks.length=unit(.25, "cm"),
                     legend.key.size = unit(3,"line"))
ggsave(gg3stage.P2, filename = file.path("report","figures","gg-pvalue2-density.pdf"), height = 10, width = 12)
#+END_SRC

#+RESULTS:
: Advarselsbeskeder:
: 1: [1m[22mRemoved 395734 rows containing non-finite values (`stat_density()`). 
: 2: [1m[22mRemoved 395734 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and adjusted p-value distribution over all simulations under the alternative. Each row correspond to a different scenario
[[./figures/gg-pvalue2-density.pdf]]

\clearpage

* Conclusion of the trial

** 2 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stageS.final <- res2stage[!is.na(statistic) & type != "interim",
                              .(.N,
                                decision.eff = mean2pc((stage == 1)*(decision == "efficacy")),
                                decision.fut = mean2pc((stage == 1)*(decision == "futility")),
                                final.eff = mean2pc((stage == 2)*(decision == "efficacy")),
                                final.fut = mean2pc((stage == 2)*(decision == "futility"))),
                              by = c("scenario","missing","method","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:

Relative frequency of stopping for efficacy/futility at decision/final

- Method 1
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==1], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_1","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10       37.79%        5.93%    43.21%    13.07%
 2: 10000    TRUE typeI    TRUE FALSE 10        0.80%       71.13%     1.62%    26.45%
 3: 10000    TRUE power    TRUE FALSE  5       35.74%        5.98%    44.79%    13.49%
 4: 10000    TRUE typeI    TRUE FALSE  5        0.74%       69.32%     1.66%    28.28%
 5: 10000    TRUE power    TRUE  TRUE 10       36.94%        6.78%    43.21%    13.07%
 6: 10000    TRUE typeI    TRUE  TRUE 10        0.62%       71.31%     1.62%    26.45%
 7: 10000    TRUE power    TRUE  TRUE  5       35.29%        6.43%    44.79%    13.49%
 8: 10000    TRUE typeI    TRUE  TRUE  5        0.66%       69.40%     1.66%    28.28%
 9: 10000    TRUE power   FALSE  TRUE 10       38.05%        6.57%    41.81%    13.57%
10: 10000    TRUE typeI   FALSE  TRUE 10        0.61%        0.20%     1.84%    97.35%
11: 10000    TRUE power   FALSE  TRUE  5       36.35%        6.15%    43.58%    13.92%
12: 10000    TRUE typeI   FALSE  TRUE  5        0.70%        0.06%     1.93%    97.31%
13: 10000    TRUE power   FALSE FALSE 10       38.69%        5.93%    41.81%    13.57%
14: 10000    TRUE typeI   FALSE FALSE 10        0.69%        0.12%     1.84%    97.35%
15: 10000    TRUE power   FALSE FALSE  5       36.79%        5.71%    43.58%    13.92%
16: 10000    TRUE typeI   FALSE FALSE  5        0.75%        0.01%     1.93%    97.31%
17: 10000   FALSE power    TRUE FALSE  5       33.98%        5.33%    46.33%    14.36%
18: 10000   FALSE typeI    TRUE FALSE  5        0.74%       67.48%     1.72%    30.06%
#+end_example

\clearpage

Method 2:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==2], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_2","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10       37.85%        6.19%    43.08%    12.88%
 2: 10000    TRUE typeI    TRUE FALSE 10        0.79%       71.64%     1.60%    25.97%
 3: 10000    TRUE power    TRUE FALSE  5       35.77%        5.99%    44.76%    13.48%
 4: 10000    TRUE typeI    TRUE FALSE  5        0.74%       69.38%     1.66%    28.22%
 5: 10000    TRUE power    TRUE  TRUE 10       36.69%        6.24%    43.66%    13.41%
 6: 10000    TRUE typeI    TRUE  TRUE 10        0.59%       69.61%     1.63%    28.17%
 7: 10000    TRUE power    TRUE  TRUE  5       35.02%        6.05%    45.18%    13.75%
 8: 10000    TRUE typeI    TRUE  TRUE  5        0.63%       68.36%     1.68%    29.33%
 9: 10000    TRUE power   FALSE  TRUE 10       37.85%        6.04%    42.27%    13.84%
10: 10000    TRUE typeI   FALSE  TRUE 10        0.61%        0.19%     1.86%    97.34%
11: 10000    TRUE power   FALSE  TRUE  5       36.18%        5.84%    43.86%    14.12%
12: 10000    TRUE typeI   FALSE  TRUE  5        0.69%        0.06%     1.95%    97.30%
13: 10000    TRUE power   FALSE FALSE 10       38.70%        6.09%    41.74%    13.47%
14: 10000    TRUE typeI   FALSE FALSE 10        0.69%        0.12%     1.84%    97.35%
15: 10000    TRUE power   FALSE FALSE  5       36.82%        5.75%    43.54%    13.89%
16: 10000    TRUE typeI   FALSE FALSE  5        0.75%        0.01%     1.93%    97.31%
17: 10000   FALSE power    TRUE FALSE  5       34.03%        5.36%    46.27%    14.34%
18: 10000   FALSE typeI    TRUE FALSE  5        0.74%       67.55%     1.72%    29.99%
#+end_example

Method 3:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==3], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_3","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC
#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10       40.58%        6.53%    39.85%    13.04%
 2: 10000    TRUE typeI    TRUE FALSE 10        0.74%       68.79%     1.63%    28.84%
 3: 10000    TRUE power    TRUE FALSE  5       36.54%        6.30%    43.60%    13.56%
 4: 10000    TRUE typeI    TRUE FALSE  5        0.69%       68.41%     1.66%    29.24%
 5: 10000    TRUE power    TRUE  TRUE 10       40.58%        6.53%    39.85%    13.04%
 6: 10000    TRUE typeI    TRUE  TRUE 10        0.74%       68.79%     1.63%    28.84%
 7: 10000    TRUE power    TRUE  TRUE  5       36.54%        6.30%    43.60%    13.56%
 8: 10000    TRUE typeI    TRUE  TRUE  5        0.69%       68.41%     1.66%    29.24%
 9: 10000    TRUE power   FALSE  TRUE 10       41.34%        6.20%    38.92%    13.54%
10: 10000    TRUE typeI   FALSE  TRUE 10        0.77%        0.33%     1.80%    97.10%
11: 10000    TRUE power   FALSE  TRUE  5       37.71%        6.03%    42.35%    13.91%
12: 10000    TRUE typeI   FALSE  TRUE  5        0.73%        0.09%     1.93%    97.25%
13: 10000    TRUE power   FALSE FALSE 10       41.34%        6.20%    38.92%    13.54%
14: 10000    TRUE typeI   FALSE FALSE 10        0.77%        0.33%     1.80%    97.10%
15: 10000    TRUE power   FALSE FALSE  5       37.71%        6.03%    42.35%    13.91%
16: 10000    TRUE typeI   FALSE FALSE  5        0.73%        0.09%     1.93%    97.25%
17: 10000   FALSE power    TRUE FALSE  5       34.65%        5.59%    45.27%    14.49%
18: 10000   FALSE typeI    TRUE FALSE  5        0.68%       66.54%     1.77%    31.01%
#+end_example

\clearpage

Relative frequency of stopping for with a threshold below 1.96:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- res2stage[decision %in% c("efficacy","futility"),
                        .(.N, rejection = mean2pc(decision=="efficacy"), rejectionBelow196 = mean2pc((statistic<qnorm(0.975))*(decision=="efficacy"))), 
                        by = c("scenario","missing","method","binding","fixC","ar","hypo")]
tablePrint[rejectionBelow196!="0"]
#+END_SRC

#+RESULTS:
#+begin_example
    scenario missing method binding  fixC ar  hypo     N rejection rejectionBelow196
 1:        1    TRUE      1    TRUE FALSE 10 power 10000    81.00%             0.85%
 2:        1    TRUE      2    TRUE FALSE 10 power 10000    80.93%             0.84%
 3:        2    TRUE      1    TRUE FALSE 10 typeI 10000     2.42%             0.18%
 4:        2    TRUE      2    TRUE FALSE 10 typeI 10000     2.39%             0.17%
 5:        3    TRUE      1    TRUE FALSE  5 power 10000    80.53%             0.45%
 6:        3    TRUE      2    TRUE FALSE  5 power 10000    80.53%             0.45%
 7:        4    TRUE      1    TRUE FALSE  5 typeI 10000     2.40%             0.08%
 8:        4    TRUE      2    TRUE FALSE  5 typeI 10000     2.40%             0.08%
 9:       13    TRUE      1   FALSE FALSE 10 power 10000    80.50%             0.64%
10:       13    TRUE      2   FALSE FALSE 10 power 10000    80.44%             0.64%
11:       14    TRUE      1   FALSE FALSE 10 typeI 10000     2.53%             0.08%
12:       14    TRUE      2   FALSE FALSE 10 typeI 10000     2.53%             0.08%
13:       15    TRUE      1   FALSE FALSE  5 power 10000    80.37%             0.44%
14:       15    TRUE      2   FALSE FALSE  5 power 10000    80.36%             0.44%
15:       16    TRUE      1   FALSE FALSE  5 typeI 10000     2.68%             0.05%
16:       16    TRUE      2   FALSE FALSE  5 typeI 10000     2.68%             0.05%
17:       17   FALSE      1    TRUE FALSE  5 power 10000    80.31%             0.42%
18:       17   FALSE      2    TRUE FALSE  5 power 10000    80.30%             0.43%
19:       18   FALSE      1    TRUE FALSE  5 typeI 10000     2.46%             0.08%
20:       18   FALSE      2    TRUE FALSE  5 typeI 10000     2.46%             0.08%
#+end_example

\clearpage

** 3 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res3stageS.final <- res3stage[!is.na(statistic) & type != "interim",
                              .(.N,
                                dec1.eff = mean2pc((stage == 1)*(decision == "efficacy")),
                                dec1.fut = mean2pc((stage == 1)*(decision == "futility")),
                                dec2.eff = mean2pc((stage == 2)*(decision == "efficacy")),
                                dec2.fut = mean2pc((stage == 2)*(decision == "futility")),
                                final.eff = mean2pc((stage == 3)*(decision == "efficacy")),
                                final.fut = mean2pc((stage == 3)*(decision == "futility"))),
                              by = c("scenario","missing","method","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:

Relative frequency of stopping for efficacy/futility at decision/final

- Method 1
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res3stageS.final[method==1], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("dec1.eff","dec1.fut","dec2.eff","dec2.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_1","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar dec1.eff dec1.fut dec2.eff dec2.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10    9.46%    1.46%   20.92%    3.30%    44.13%    20.73%
 2: 10000    TRUE typeI    TRUE FALSE 10    0.23%   26.36%    0.48%   35.88%     1.89%    35.16%
 3: 10000    TRUE power    TRUE FALSE  5    9.90%    1.65%   20.79%    3.54%    43.66%    20.46%
 4: 10000    TRUE typeI    TRUE FALSE  5    0.27%   27.41%    0.39%   35.44%     1.95%    34.54%
 5: 10000    TRUE power    TRUE  TRUE 10    9.27%    1.65%   20.44%    3.78%    44.13%    20.73%
 6: 10000    TRUE typeI    TRUE  TRUE 10    0.17%   26.42%    0.41%   35.95%     1.89%    35.16%
 7: 10000    TRUE power    TRUE  TRUE  5    9.75%    1.80%   20.59%    3.74%    43.66%    20.46%
 8: 10000    TRUE typeI    TRUE  TRUE  5    0.25%   27.43%    0.36%   35.47%     1.95%    34.54%
 9: 10000    TRUE power   FALSE  TRUE 10    9.60%    1.62%   20.44%    3.60%    44.13%    20.61%
10:  9990    TRUE typeI   FALSE  TRUE 10    0.16%    0.07%    0.34%    0.11%     1.87%    97.45%
11: 10000    TRUE power   FALSE  TRUE  5   10.34%    1.78%   20.48%    3.35%    43.51%    20.54%
12: 10000    TRUE typeI   FALSE  TRUE  5    0.27%    0.02%    0.36%    0.08%     1.80%    97.47%
13: 10000    TRUE power   FALSE FALSE 10    9.83%    1.39%   20.75%    3.29%    44.13%    20.61%
14:  9990    TRUE typeI   FALSE FALSE 10    0.21%    0.02%    0.41%    0.04%     1.87%    97.45%
15: 10000    TRUE power   FALSE FALSE  5   10.46%    1.66%   20.64%    3.19%    43.51%    20.54%
16: 10000    TRUE typeI   FALSE FALSE  5    0.29%        0    0.44%        0     1.80%    97.47%
17: 10000   FALSE power    TRUE FALSE  5    8.93%    1.66%   19.60%    2.97%    43.65%    23.19%
18: 10000   FALSE typeI    TRUE FALSE  5    0.23%   25.91%    0.38%   34.48%     2.00%    37.00%
#+end_example

- Method 2
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res3stageS.final[method==2], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("dec1.eff","dec1.fut","dec2.eff","dec2.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_2","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar dec1.eff dec1.fut dec2.eff dec2.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10    9.49%    1.47%   20.92%    3.32%    44.10%    20.70%
 2: 10000    TRUE typeI    TRUE FALSE 10    0.23%   26.43%    0.48%   35.92%     1.89%    35.05%
 3: 10000    TRUE power    TRUE FALSE  5    9.91%    1.65%   20.81%    3.55%    43.63%    20.45%
 4: 10000    TRUE typeI    TRUE FALSE  5    0.27%   27.42%    0.39%   35.46%     1.95%    34.51%
 5: 10000    TRUE power    TRUE  TRUE 10    9.14%    1.51%   20.35%    3.43%    44.42%    21.15%
 6: 10000    TRUE typeI    TRUE  TRUE 10    0.17%   25.29%    0.41%   35.73%     1.92%    36.48%
 7: 10000    TRUE power    TRUE  TRUE  5    9.67%    1.74%   20.46%    3.64%    43.88%    20.61%
 8: 10000    TRUE typeI    TRUE  TRUE  5    0.24%   26.94%    0.35%   35.19%     1.96%    35.32%
 9: 10000    TRUE power   FALSE  TRUE 10    9.56%    1.46%   20.30%    3.39%    44.39%    20.90%
10:  9990    TRUE typeI   FALSE  TRUE 10    0.16%    0.07%    0.34%    0.11%     1.87%    97.45%
11: 10000    TRUE power   FALSE  TRUE  5   10.27%    1.74%   20.29%    3.26%    43.81%    20.63%
12: 10000    TRUE typeI   FALSE  TRUE  5    0.27%    0.02%    0.36%    0.07%     1.81%    97.47%
13: 10000    TRUE power   FALSE FALSE 10    9.84%    1.40%   20.75%    3.29%    44.12%    20.60%
14:  9990    TRUE typeI   FALSE FALSE 10    0.21%    0.02%    0.41%    0.04%     1.87%    97.45%
15: 10000    TRUE power   FALSE FALSE  5   10.47%    1.67%   20.64%    3.19%    43.48%    20.55%
16: 10000    TRUE typeI   FALSE FALSE  5    0.29%        0    0.45%        0     1.79%    97.47%
17: 10000   FALSE power    TRUE FALSE  5    8.93%    1.66%   19.62%    2.98%    43.63%    23.18%
18: 10000   FALSE typeI    TRUE FALSE  5    0.23%   25.96%    0.38%   34.49%     2.00%    36.94%
#+end_example

\clearpage

- Method 3
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res3stageS.final[method==3], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("dec1.eff","dec1.fut","dec2.eff","dec2.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_3","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar dec1.eff dec1.fut dec2.eff dec2.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10    9.90%    1.60%   21.38%    3.57%    42.73%    20.82%
 2: 10000    TRUE typeI    TRUE FALSE 10    0.18%   25.24%    0.42%   35.72%     1.89%    36.55%
 3: 10000    TRUE power    TRUE FALSE  5    9.85%    1.79%   20.78%    3.71%    43.36%    20.51%
 4: 10000    TRUE typeI    TRUE FALSE  5    0.25%   27.11%    0.38%   35.31%     1.96%    34.99%
 5: 10000    TRUE power    TRUE  TRUE 10    9.90%    1.60%   21.38%    3.57%    42.73%    20.82%
 6: 10000    TRUE typeI    TRUE  TRUE 10    0.18%   25.24%    0.42%   35.72%     1.89%    36.55%
 7: 10000    TRUE power    TRUE  TRUE  5    9.85%    1.79%   20.78%    3.71%    43.36%    20.51%
 8: 10000    TRUE typeI    TRUE  TRUE  5    0.25%   27.11%    0.38%   35.31%     1.96%    34.99%
 9: 10000    TRUE power   FALSE  TRUE 10   10.35%    1.54%   21.20%    3.42%    42.90%    20.59%
10:  9990    TRUE typeI   FALSE  TRUE 10    0.17%    0.10%    0.38%    0.12%     1.87%    97.36%
11: 10000    TRUE power   FALSE  TRUE  5   10.60%    1.77%   20.68%    3.32%    43.15%    20.48%
12: 10000    TRUE typeI   FALSE  TRUE  5    0.27%    0.03%    0.39%    0.08%     1.78%    97.45%
13: 10000    TRUE power   FALSE FALSE 10   10.35%    1.54%   21.20%    3.42%    42.90%    20.59%
14:  9990    TRUE typeI   FALSE FALSE 10    0.17%    0.10%    0.38%    0.12%     1.87%    97.36%
15: 10000    TRUE power   FALSE FALSE  5   10.60%    1.77%   20.68%    3.32%    43.15%    20.48%
16: 10000    TRUE typeI   FALSE FALSE  5    0.27%    0.03%    0.39%    0.08%     1.78%    97.45%
17: 10000   FALSE power    TRUE FALSE  5    8.94%    1.77%   19.69%    3.03%    43.34%    23.23%
18: 10000   FALSE typeI    TRUE FALSE  5    0.21%   25.61%    0.33%   34.46%     2.00%    37.39%
#+end_example

Relative frequency of stopping for with a threshold below 1.96:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- res3stage[decision %in% c("efficacy","futility"),
                        .(.N, rejection = mean2pc(decision=="efficacy"), rejectionBelow196 = mean2pc((statistic<qnorm(0.975))*(decision=="efficacy"))), 
                        by = c("scenario","missing","method","binding","fixC","ar","hypo")]
tablePrint[rejectionBelow196!=0]
#+END_SRC

#+RESULTS:
#+begin_example
    scenario missing method binding  fixC ar  hypo     N rejection rejectionBelow196
 1:        1    TRUE      1    TRUE FALSE 10 power 10000    74.51%             0.67%
 2:        1    TRUE      2    TRUE FALSE 10 power 10000    74.51%             0.67%
 3:        2    TRUE      1    TRUE FALSE 10 typeI 10000     2.60%             0.13%
 4:        2    TRUE      2    TRUE FALSE 10 typeI 10000     2.60%             0.13%
 5:        3    TRUE      1    TRUE FALSE  5 power 10000    74.35%             0.35%
 6:        3    TRUE      2    TRUE FALSE  5 power 10000    74.35%             0.35%
 7:        4    TRUE      1    TRUE FALSE  5 typeI 10000     2.61%             0.05%
 8:        4    TRUE      2    TRUE FALSE  5 typeI 10000     2.61%             0.05%
 9:       13    TRUE      1   FALSE FALSE 10 power 10000    74.71%             0.54%
10:       13    TRUE      2   FALSE FALSE 10 power 10000    74.71%             0.54%
11:       14    TRUE      1   FALSE FALSE 10 typeI  9990     2.49%             0.12%
12:       14    TRUE      2   FALSE FALSE 10 typeI  9990     2.49%             0.12%
13:       15    TRUE      1   FALSE FALSE  5 power 10000    74.61%             0.28%
14:       15    TRUE      2   FALSE FALSE  5 power 10000    74.59%             0.28%
15:       16    TRUE      1   FALSE FALSE  5 typeI 10000     2.53%             0.10%
16:       16    TRUE      2   FALSE FALSE  5 typeI 10000     2.53%             0.10%
17:       17   FALSE      1    TRUE FALSE  5 power 10000    72.18%             0.29%
18:       17   FALSE      2    TRUE FALSE  5 power 10000    72.18%             0.29%
19:       18   FALSE      1    TRUE FALSE  5 typeI 10000     2.61%             0.08%
20:       18   FALSE      2    TRUE FALSE  5 typeI 10000     2.61%             0.08%
#+end_example


\clearpage

* Bias (True effect: 0.6 under the alternative)

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
true_eff <- 0.6
#+END_SRC

#+RESULTS:

** 2 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## For each run, error made by each estimator
res2stage[, truth := c(0,true_eff)[(hypo=="power")+1]]
res2stage.bias <- res2stage[decision %in% c("futility","efficacy"),
                            .(N = .N,
                              bias_MLE = estimate_ML-truth,
                              bias_MUE = estimate_MUE-truth,
                              mbias_MLE = (estimate_ML>truth) - 0.5,
                              mbias_MUE = (estimate_MUE>truth) - 0.5),
                            by = c("method","scenario","seed","missing","binding","fixC","ar","hypo")]
all(res2stage.bias$N==1)

res2stageS.bias <- res2stage.bias[,.(N = .N,
                                     bias_MLE = mean(bias_MLE, na.rm = TRUE),
                                     bias_MUE = mean(bias_MUE, na.rm = TRUE),
                                     mbias_MLE = mean(mbias_MLE, na.rm = TRUE),
                                     mbias_MUE = mean(mbias_MUE, na.rm = TRUE)),
                                  by=c("method","scenario","missing","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:
: [1] TRUE

Bias per estimator and method[fn::e.g. \texttt{biasMLE1} mixed model
estimator (treatment effect), method 1 (boundaries)]:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.bias,
                    hypo + scenario + missing + binding + fixC + ar ~ method,
                    value.var = c("bias_MLE","bias_MUE"))
setkeyv(tablePrint,"scenario")
names(tablePrint) <- gsub("_","",names(tablePrint),fixed = TRUE)
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 2)
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing binding  fixC ar biasMLE1 biasMLE2 biasMLE3 biasMUE1 biasMUE2 biasMUE3
 1: power    TRUE    TRUE FALSE 10  0.01345  0.01315  0.01468  0.00598  0.00566 -0.00286
 2: typeI    TRUE    TRUE FALSE 10 -0.01794 -0.01784 -0.01856 -0.00453 -0.00448 -0.00513
 3: power    TRUE    TRUE FALSE  5  0.02257  0.02255  0.02358  0.01044  0.01047  0.00364
 4: typeI    TRUE    TRUE FALSE  5 -0.03034 -0.03031 -0.03065 -0.01186 -0.01182 -0.01244
 5: power    TRUE    TRUE  TRUE 10  0.01345  0.01403  0.01468 -0.01482 -0.01515 -0.00286
 6: typeI    TRUE    TRUE  TRUE 10 -0.01794 -0.01871 -0.01856 -0.00553 -0.00619 -0.00513
 7: power    TRUE    TRUE  TRUE  5  0.02257  0.02309  0.02358 -0.01511 -0.01521  0.00364
 8: typeI    TRUE    TRUE  TRUE  5 -0.03034 -0.03085 -0.03065 -0.01249 -0.01307 -0.01244
 9: power    TRUE   FALSE  TRUE 10  0.01433  0.01490  0.01529  0.01725  0.01500  0.02897
10: typeI    TRUE   FALSE  TRUE 10  0.00019  0.00019  0.00051 -0.00087 -0.00079  0.00073
11: power    TRUE   FALSE  TRUE  5  0.02366  0.02402  0.02438  0.01667  0.01524  0.03653
12: typeI    TRUE   FALSE  TRUE  5  0.00091  0.00085  0.00101  0.00033  0.00027  0.00086
13: power    TRUE   FALSE FALSE 10  0.01433  0.01416  0.01529  0.03552  0.03589  0.02897
14: typeI    TRUE   FALSE FALSE 10  0.00019  0.00019  0.00051 -0.00020 -0.00021  0.00073
15: power    TRUE   FALSE FALSE  5  0.02366  0.02365  0.02438  0.04186  0.04202  0.03653
16: typeI    TRUE   FALSE FALSE  5  0.00091  0.00091  0.00101  0.00087  0.00087  0.00086
17: power   FALSE    TRUE FALSE  5  0.02284  0.02277  0.02381  0.01197  0.01196  0.00412
18: typeI   FALSE    TRUE FALSE  5 -0.02952 -0.02945 -0.02992 -0.01111 -0.01106 -0.01172
#+end_example
#+LaTeX: \end{adjustwidth}

Median bias [fn::Relative frequency at which the estimate is greater than the truth minus 0.5] per estimator and method:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.bias,
                    hypo + scenario + missing + binding + fixC + ar ~ method,
                    value.var = c("mbias_MLE","mbias_MUE"))
setkeyv(tablePrint,"scenario")
names(tablePrint) <- gsub("_","",names(tablePrint),fixed = TRUE)
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 2)
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing binding  fixC ar mbiasMLE1 mbiasMLE2 mbiasMLE3 mbiasMUE1 mbiasMUE2 mbiasMUE3
 1: power    TRUE    TRUE FALSE 10    0.0261    0.0260    0.0301  -0.00240  -0.00250  -0.00545
 2: typeI    TRUE    TRUE FALSE 10   -0.0173   -0.0170   -0.0202   0.00100   0.00075  -0.00015
 3: power    TRUE    TRUE FALSE  5    0.0405    0.0405    0.0432  -0.00345  -0.00335  -0.00545
 4: typeI    TRUE    TRUE FALSE  5   -0.0330   -0.0329   -0.0345   0.00055   0.00055   0.00065
 5: power    TRUE    TRUE  TRUE 10    0.0261    0.0265    0.0301  -0.01110  -0.01050  -0.00545
 6: typeI    TRUE    TRUE  TRUE 10   -0.0173   -0.0197   -0.0202   0.00100  -0.00065  -0.00015
 7: power    TRUE    TRUE  TRUE  5    0.0405    0.0407    0.0432  -0.00865  -0.00755  -0.00545
 8: typeI    TRUE    TRUE  TRUE  5   -0.0330   -0.0346   -0.0345   0.00055   0.00075   0.00065
 9: power    TRUE   FALSE  TRUE 10    0.0326    0.0332    0.0327   0.02719   0.02475   0.02804
10: typeI    TRUE   FALSE  TRUE 10   -0.0009   -0.0009   -0.0009  -0.00190  -0.00185  -0.00025
11: power    TRUE   FALSE  TRUE  5    0.0462    0.0459    0.0489   0.02568   0.02469   0.02799
12: typeI    TRUE   FALSE  TRUE  5   -0.0009   -0.0010   -0.0009  -0.00130  -0.00140  -0.00015
13: power    TRUE   FALSE FALSE 10    0.0326    0.0324    0.0327   0.03094   0.03184   0.02804
14: typeI    TRUE   FALSE FALSE 10   -0.0009   -0.0009   -0.0009  -0.00150  -0.00140  -0.00025
15: power    TRUE   FALSE FALSE  5    0.0462    0.0464    0.0489   0.02832   0.02865   0.02799
16: typeI    TRUE   FALSE FALSE  5   -0.0009   -0.0009   -0.0009  -0.00105  -0.00105  -0.00015
17: power   FALSE    TRUE FALSE  5    0.0383    0.0383    0.0400  -0.00265  -0.00255  -0.00485
18: typeI   FALSE    TRUE FALSE  5   -0.0329   -0.0327   -0.0353   0.00420   0.00420   0.00330
#+end_example

#+LaTeX: \end{adjustwidth}

\clearpage

** 3 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## For each run, error made by each estimator
res3stage[, truth := c(0,true_eff)[(hypo=="power")+1]]
res3stage.bias <- res3stage[decision %in% c("futility","efficacy"),
                            .(N = .N,
                              bias_MLE = estimate_ML-truth,
                              bias_MUE = estimate_MUE-truth,
                              mbias_MLE = (estimate_ML>truth) - 0.5,
                              mbias_MUE = (estimate_MUE>truth) - 0.5),
                            by = c("method","scenario","seed","missing","binding","fixC","ar","hypo")]
all(res3stage.bias$N==1)

res3stageS.bias <- res3stage.bias[,.(N = .N,
                                     bias_MLE = mean(bias_MLE, na.rm = TRUE),
                                     bias_MUE = mean(bias_MUE, na.rm = TRUE),
                                     mbias_MLE = mean(mbias_MLE, na.rm = TRUE),
                                     mbias_MUE = mean(mbias_MUE, na.rm = TRUE)),
                                  by=c("method","scenario","missing","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:
: [1] TRUE

Bias per estimator and method[fn::e.g. \texttt{biasMLE1} mixed model
estimator (treatment effect), method 1 (boundaries)]:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res3stageS.bias,
                    hypo + scenario + missing + binding + fixC + ar ~ method,
                    value.var = c("bias_MLE","bias_MUE"))
setkeyv(tablePrint,"scenario")
names(tablePrint) <- gsub("_","",names(tablePrint),fixed = TRUE)
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 2)
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing binding  fixC ar biasMLE1 biasMLE2 biasMLE3 biasMUE1 biasMUE2 biasMUE3
 1: power    TRUE    TRUE FALSE 10   0.0212   0.0212   0.0228   0.0233   0.0233   0.0136
 2: typeI    TRUE    TRUE FALSE 10  -0.0348  -0.0348  -0.0340  -0.0268  -0.0268  -0.0280
 3: power    TRUE    TRUE FALSE  5   0.0344   0.0344   0.0350   0.0258   0.0258   0.0164
 4: typeI    TRUE    TRUE FALSE  5  -0.0563  -0.0562  -0.0560  -0.0336  -0.0335  -0.0339
 5: power    TRUE    TRUE  TRUE 10   0.0212   0.0214   0.0228   0.0077   0.0080   0.0136
 6: typeI    TRUE    TRUE  TRUE 10  -0.0348  -0.0340  -0.0340  -0.0280  -0.0283  -0.0280
 7: power    TRUE    TRUE  TRUE  5   0.0344   0.0345   0.0350   0.0053   0.0056   0.0164
 8: typeI    TRUE    TRUE  TRUE  5  -0.0563  -0.0562  -0.0560  -0.0341  -0.0344  -0.0339
 9: power    TRUE   FALSE  TRUE 10   0.0209   0.0212   0.0224   0.0375   0.0359   0.0422
10: typeI    TRUE   FALSE  TRUE 10   0.0027   0.0027   0.0028   0.0023   0.0023   0.0029
11: power    TRUE   FALSE  TRUE  5   0.0339   0.0340   0.0347   0.0376   0.0369   0.0494
12: typeI    TRUE   FALSE  TRUE  5   0.0037   0.0037   0.0038   0.0034   0.0035   0.0037
13: power    TRUE   FALSE FALSE 10   0.0209   0.0209   0.0224   0.0505   0.0505   0.0422
14: typeI    TRUE   FALSE FALSE 10   0.0027   0.0027   0.0028   0.0031   0.0031   0.0029
15: power    TRUE   FALSE FALSE  5   0.0339   0.0339   0.0347   0.0572   0.0572   0.0494
16: typeI    TRUE   FALSE FALSE  5   0.0037   0.0038   0.0038   0.0044   0.0044   0.0037
17: power   FALSE    TRUE FALSE  5   0.0303   0.0303   0.0310   0.0235   0.0235   0.0149
18: typeI   FALSE    TRUE FALSE  5  -0.0565  -0.0565  -0.0564  -0.0362  -0.0363  -0.0368
#+end_example
#+LaTeX: \end{adjustwidth}

Median bias [fn::Relative frequency at which the estimate is greater than the truth minus 0.5] per estimator and method:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res3stageS.bias,
                    hypo + scenario + missing + binding + fixC + ar ~ method,
                    value.var = c("mbias_MLE","mbias_MUE"))
setkeyv(tablePrint,"scenario")
names(tablePrint) <- gsub("_","",names(tablePrint),fixed = TRUE)
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 2)
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing binding  fixC ar mbiasMLE1 mbiasMLE2 mbiasMLE3 mbiasMUE1 mbiasMUE2 mbiasMUE3
 1: power    TRUE    TRUE FALSE 10    0.0281    0.0281    0.0300    0.0072   0.00700    0.0025
 2: typeI    TRUE    TRUE FALSE 10   -0.0389   -0.0388   -0.0376   -0.0001   0.00020    0.0013
 3: power    TRUE    TRUE FALSE  5    0.0391    0.0390    0.0400    0.0081   0.00800    0.0053
 4: typeI    TRUE    TRUE FALSE  5   -0.0660   -0.0658   -0.0660   -0.0015  -0.00115   -0.0013
 5: power    TRUE    TRUE  TRUE 10    0.0281    0.0280    0.0300    0.0013   0.00185    0.0025
 6: typeI    TRUE    TRUE  TRUE 10   -0.0389   -0.0377   -0.0376   -0.0005   0.00075    0.0011
 7: power    TRUE    TRUE  TRUE  5    0.0391    0.0387    0.0400    0.0050   0.00530    0.0053
 8: typeI    TRUE    TRUE  TRUE  5   -0.0660   -0.0660   -0.0660   -0.0016  -0.00120   -0.0012
 9: power    TRUE   FALSE  TRUE 10    0.0175    0.0173    0.0188    0.0233   0.02086    0.0221
10: typeI    TRUE   FALSE  TRUE 10   -0.0036   -0.0036   -0.0036   -0.0045  -0.00451   -0.0040
11: power    TRUE   FALSE  TRUE  5    0.0275    0.0272    0.0287    0.0241   0.02347    0.0252
12: typeI    TRUE   FALSE  TRUE  5   -0.0035   -0.0035   -0.0035   -0.0039  -0.00385   -0.0037
13: power    TRUE   FALSE FALSE 10    0.0175    0.0174    0.0188    0.0260   0.02586    0.0221
14: typeI    TRUE   FALSE FALSE 10   -0.0036   -0.0036   -0.0036   -0.0040  -0.00401   -0.0039
15: power    TRUE   FALSE FALSE  5    0.0275    0.0275    0.0287    0.0255   0.02554    0.0252
16: typeI    TRUE   FALSE FALSE  5   -0.0035   -0.0035   -0.0035   -0.0034  -0.00350   -0.0039
17: power   FALSE    TRUE FALSE  5    0.0244    0.0245    0.0251    0.0036   0.00360    0.0014
18: typeI   FALSE    TRUE FALSE  5   -0.0634   -0.0632   -0.0630   -0.0041  -0.00425   -0.0037
#+end_example

#+LaTeX: \end{adjustwidth}

\clearpage

* Distribution of the estimates

** 2 stages
Distribution of the estimates:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Restrict to one observation per run, when we stop:
dt2stage.estimate <- res2stage[decision %in% c("futility","efficacy") & !is.na(statistic),]
## Distribution of the estimate:
gg2stage.E <- ggplot(dt2stage.estimate) + facet_grid(scenario~method.char)
gg2stage.E <- gg2stage.E + geom_density(alpha=0.25, aes(x = estimate_ML, fill = "Naive"))
gg2stage.E <- gg2stage.E + geom_density(alpha=0.25, aes(x = estimate_MUE, fill = "Median unbiased"))
gg2stage.E <- gg2stage.E + labs(fill = "Estimator", x = "Estimate", y = "Density")
gg2stage.E <- gg2stage.E + geom_vline(aes(xintercept = truth), color = "purple")
gg2stage.E <- gg2stage.E + theme(text = element_text(size=15), 
                                 axis.line = element_line(linewidth = 1.25),
                                 axis.ticks = element_line(linewidth = 2),
                                 axis.ticks.length=unit(.25, "cm"),
                                 legend.key.size = unit(3,"line"))

ggsave(gg2stage.E, filename = file.path("report","figures","gg2stage-estimate-density.pdf"), height = 10, width = 12)
ggsave(gg2stage.E %+% dt2stage.estimate[scenario == 1] + theme(legend.position = "bottom"),
       filename = file.path("report","figures","gg2stage-estimate-density-scenario1.pdf"), width = 10)
#+END_SRC

#+RESULTS:
: Advarselsbesked:
: [1m[22mRemoved 7470 rows containing non-finite values (`stat_density()`).
: [1m[22mSaving 10 x 7 in image
: Advarselsbesked:
: [1m[22mRemoved 1 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and Median unbiased estimate distribution over all simulations. Each row correspond to a different scenario
[[./figures/gg2stage-estimate-density.pdf]]

#+ATTR_LaTeX: :width \textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Same but specific to scenario 1
[[./figures/gg2stage-estimate-density-scenario1.pdf]]

\clearpage

Distribution of the median unbiased estimate conditional to the stage:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
gg2stage.estimateC <- ggplot(dt2stage.estimate, aes(x = estimate_MUE, fill = stage.char, group = stage.char))
gg2stage.estimateC <- gg2stage.estimateC + geom_density(alpha=0.25) + facet_grid(scenario~method.char)
gg2stage.estimateC <- gg2stage.estimateC + labs(x = "estimate", fill = "stage", y = "Density")
gg2stage.estimateC <- gg2stage.estimateC + theme(text = element_text(size=15), 
                                     axis.line = element_line(linewidth = 1.25),
                                     axis.ticks = element_line(linewidth = 2),
                                     axis.ticks.length=unit(.25, "cm"),
                                     legend.key.size = unit(3,"line"))

ggsave(gg2stage.estimateC, filename = file.path("report","figures","gg2stage-estimateC-density.pdf"),
       height = 10, width = 12)
#+END_SRC

#+RESULTS:
: Advarselsbesked:
: [1m[22mRemoved 7476 rows containing non-finite values (`stat_density()`).
: [1m[22mSaving 10 x 7 in image
: Advarselsbesked:
: [1m[22mRemoved 1 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Median unbiased estimate distribution conditional to the stage. Each row correspond to a different scenario.
[[./figures/gg2stage-estimateC-density.pdf]]

\clearpage

** 3 stages

Distribution of the estimates:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Restrict to one observation per run, when we stop:
dt3stage.estimate <- res3stage[decision %in% c("futility","efficacy") & !is.na(statistic),]
## Distribution of the estimate:
gg3stage.E <- ggplot(dt3stage.estimate) + facet_grid(scenario~method.char)
gg3stage.E <- gg3stage.E + geom_density(alpha=0.25, aes(x = estimate_ML, fill = "Naive"))
gg3stage.E <- gg3stage.E + geom_density(alpha=0.25, aes(x = estimate_MUE, fill = "Median unbiased"))
gg3stage.E <- gg3stage.E + labs(fill = "Estimator", x = "Estimate", y = "Density")
gg3stage.E <- gg3stage.E + geom_vline(aes(xintercept = truth), color = "purple")
gg3stage.E <- gg3stage.E + theme(text = element_text(size=15), 
                                 axis.line = element_line(linewidth = 1.25),
                                 axis.ticks = element_line(linewidth = 2),
                                 axis.ticks.length=unit(.25, "cm"),
                                 legend.key.size = unit(3,"line"))

ggsave(gg3stage.E, filename = file.path("report","figures","gg3stage-estimate-density.pdf"), height = 10, width = 12)
ggsave(gg3stage.E %+% dt3stage.estimate[scenario == 1] + theme(legend.position = "bottom"),
       filename = file.path("report","figures","gg3stage-estimate-density-scenario1.pdf"), width = 10)
#+END_SRC

#+RESULTS:
: Advarselsbesked:
: [1m[22mRemoved 7476 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and Median unbiased estimate distribution over all simulations. Each row correspond to a different scenario
[[./figures/gg3stage-estimate-density.pdf]]

#+ATTR_LaTeX: :width \textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Same but specific to scenario 1
[[./figures/gg3stage-estimate-density-scenario1.pdf]]

\clearpage

Distribution of the median unbiased estimate conditional to the stage:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
gg3stage.estimateC <- ggplot(dt3stage.estimate, aes(x = estimate_MUE, fill = stage.char, group = stage.char))
gg3stage.estimateC <- gg3stage.estimateC + geom_density(alpha=0.25) + facet_grid(scenario~method.char)
gg3stage.estimateC <- gg3stage.estimateC + labs(x = "estimate", fill = "stage", y = "Density")
gg3stage.estimateC <- gg3stage.estimateC + theme(text = element_text(size=15), 
                                     axis.line = element_line(linewidth = 1.25),
                                     axis.ticks = element_line(linewidth = 2),
                                     axis.ticks.length=unit(.25, "cm"),
                                     legend.key.size = unit(3,"line"))

ggsave(gg3stage.estimateC, filename = file.path("report","figures","gg3stage-estimateC-density.pdf"),
       height = 10, width = 12)
#+END_SRC

#+RESULTS:
: [1m[22mSaving 10 x 7 in image
: Advarselsbesked:
: [1m[22mRemoved 33 rows containing non-finite values (`stat_density()`).

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Median unbiased estimate distribution conditional to the stage. Each row correspond to a different scenario.
[[./figures/gg3stage-estimateC-density.pdf]]

\clearpage

* Special cases

** 2 stages

Reason for stopping (efficacy, futility, Imax reached), continuing the
trial (decreasing information, no boundary crossed), or concluding
(stop for futility at interim):
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res2stage[scenario %in% 1:8,reason],
       method = res2stage[scenario %in% 1:8,method],
       scenario = res2stage[scenario %in% 1:8,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                                    scenario    1    2    3    4    5    6    7    8
reason                       method                                                 
decreasing information       1                  0    0    1    1    0    0    1    1
                             2                  0    0    1    1    0    0    1    1
                             3                  0    0    1    1    0    0    1    1
efficacy                     1               3739   81 3573   74 3739   81 3573   74
                             2               3744   81 3576   74 3718   79 3545   71
                             3               4165  108 3721   82 4165  108 3721   82
futility                     1                632 7111  599 6932  632 7111  599 6932
                             2                659 7161  600 6938  574 6940  562 6828
                             3                545 6844  563 6828  545 6844  563 6828
Imax reached                 1                  1    1    0    0    1    1    0    0
                             2                  1    1    0    0    1    1    0    0
                             3                  1    1    0    0    1    1    0    0
no boundary crossed          1               5628 2807 5828 2994 5628 2807 5828 2994
                             2               5596 2757 5824 2988 5707 2980 5893 3101
                             3               5289 3047 5716 3090 5289 3047 5716 3090
stop for futility at interim 1                  0    0    0    0    0    0    0    0
                             2                  0    0    0    0    0    0    0    0
                             3                 11    1    2    0   11    1    2    0
#+end_example

#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res2stage[scenario %in% 9:18,reason],
       method = res2stage[scenario %in% 9:18,method],
       scenario = res2stage[scenario %in% 9:18,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                                    scenario    9   10   11   12   13   14   15   16   17   18
reason                       method                                                           
efficacy                     1               3849   81 3680   76 3849   81 3680   76 3396   74
                             2               3829   80 3661   75 3850   81 3683   76 3400   74
                             3               4238  110 3831   82 4238  110 3831   82 3528   80
futility                     1                613 7122  570 6945  613 7122  570 6945  535 6748
                             2                560 6975  541 6838  629 7164  574 6950  539 6755
                             3                516 6890  543 6842  516 6890  543 6842  496 6642
no boundary crossed          1               5538 2797 5750 2979 5538 2797 5750 2979 6069 3178
                             2               5611 2945 5798 3087 5521 2755 5743 2974 6061 3171
                             3               5246 3000 5626 3076 5246 3000 5626 3076 5976 3278
stop for futility at interim 1                  0    0    0    0    0    0    0    0    0    0
                             2                  0    0    0    0    0    0    0    0    0    0
                             3                  8    0    0    0    8    0    0    0    1    0
#+end_example

\clearpage

** 3 stages

Reason for stopping (efficacy, futility, Imax reached), continuing the
trial (decreasing information, no boundary crossed), or concluding
(stop for futility at interim):
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res3stage[scenario %in% 1:8,reason],
       method = res3stage[scenario %in% 1:8,method],
       scenario = res3stage[scenario %in% 1:8,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                                    scenario     1     2     3     4     5     6     7     8
reason                       method                                                         
efficacy                     1                3021    71  3070    67  3021    71  3070    67
                             2                3024    71  3073    67  2995    71  3048    65
                             3                3201    82  3108    69  3201    82  3108    69
futility                     1                 493  6224   518  6284   493  6224   518  6284
                             2                 496  6235   519  6287   448  6089   503  6207
                             3                 444  6074   505  6236   444  6074   505  6236
no boundary crossed          1               15394 11046 15257 10881 15394 11046 15257 10881
                             2               15384 11028 15252 10877 15492 11294 15308 11010
                             3               15205 11302 15223 10959 15205 11302 15223 10959
stop for futility at interim 1                   0     0     0     0     0     0     0     0
                             2                   0     0     0     0     0     0     0     0
                             3                   3     1     0     0     3     1     0     0
#+end_example

#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res3stage[scenario %in% 9:18,reason],
       method = res3stage[scenario %in% 9:18,method],
       scenario = res3stage[scenario %in% 9:18,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                                    scenario     9    10    11    12    13    14    15    16    17    18
reason                       method                                                                     
efficacy                     1                3046    68  3110    73  3046    68  3110    73  2851    61
                             2                3028    68  3083    72  3047    68  3111    74  2853    61
                             3                3212    77  3160    77  3212    77  3160    77  2894    62
futility                     1                 480  8907   485  9058   480  8907   485  9058   465  6039
                             2                 443  8657   473  8953   481  8924   486  9063   466  6045
                             3                 439  8644   477  9002   439  8644   477  9002   449  5999
no boundary crossed          1               15352 10982 15193 10840 15352 10982 15193 10840 15625 11286
                             2               15427 11232 15243 10946 15348 10965 15189 10834 15622 11275
                             3               15160 11232 15126 10891 15160 11232 15126 10891 15586 11357
stop for futility at interim 1                   0     0     0     0     0     0     0     0     0     0
                             2                   0     0     0     0     0     0     0     0     0     0
                             3                   3     0     1     0     3     0     1     0     0     0
#+end_example

\clearpage

* Reversal probability

** 2 stages

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Indicator of reversal
res2stage.reversal <- res2stage[,.(N=.N,
                                   stopInterim = c(.SD[type=="interim"&decision=="stop",reason],"none")[1],
                                   decision = c(.SD[type=="decision",decision],"none")[1],
                                   futility2efficacy = FALSE,
                                   efficacy2futility = FALSE),
                                by = c("method","scenario","seed","missing","binding","fixC","ar","hypo")]
res2stage.reversal[(stopInterim == "futility") & (decision == "efficacy"), futility2efficacy := TRUE]
res2stage.reversal[(stopInterim == "efficacy") & (decision == "futility"), efficacy2futility := TRUE]
#+END_SRC

#+RESULTS:


Percentage of time we observe a reversal:

#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stageS.reversal <- res2stage.reversal[, .(N = .N,
                                              fu2eff = mean2pc(futility2efficacy),
                                              eff2fu = mean2pc(efficacy2futility)),
                                          by = c("method","scenario","missing","binding","fixC","ar","hypo")]
tablePrint <- dcast(res2stageS.reversal, scenario + N + hypo + missing + ar + binding + fixC ~ method, value.var = c("fu2eff","eff2fu"))
print(tablePrint[order(tablePrint$scenario),.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC

#+RESULTS:
#+begin_example
        N  hypo missing ar binding  fixC fu2eff_1 fu2eff_2 fu2eff_3 eff2fu_1 eff2fu_2 eff2fu_3
 1: 10000 power    TRUE 10    TRUE FALSE    0.57%    0.61%        0    0.17%    0.20%    1.07%
 2: 10000 typeI    TRUE 10    TRUE FALSE    0.10%    0.09%        0    0.11%    0.11%    0.34%
 3: 10000 power    TRUE  5    TRUE FALSE    0.08%    0.08%        0    0.07%    0.07%    0.67%
 4: 10000 typeI    TRUE  5    TRUE FALSE    0.02%    0.02%        0    0.02%    0.02%    0.13%
 5: 10000 power    TRUE 10    TRUE  TRUE    0.22%    0.16%        0    0.67%    0.65%    1.07%
 6: 10000 typeI    TRUE 10    TRUE  TRUE    0.02%    0.01%        0    0.21%    0.21%    0.34%
 7: 10000 power    TRUE  5    TRUE  TRUE    0.02%    0.02%        0    0.46%    0.45%    0.67%
 8: 10000 typeI    TRUE  5    TRUE  TRUE        0        0        0    0.08%    0.08%    0.13%
 9: 10000 power    TRUE 10   FALSE  TRUE    0.14%    0.11%        0    0.58%    0.55%    1.04%
10: 10000 typeI    TRUE 10   FALSE  TRUE        0        0        0    0.20%    0.19%    0.33%
11: 10000 power    TRUE  5   FALSE  TRUE    0.01%    0.01%        0    0.46%    0.44%    0.60%
12: 10000 typeI    TRUE  5   FALSE  TRUE        0        0        0    0.06%    0.06%    0.09%
13: 10000 power    TRUE 10   FALSE FALSE    0.41%    0.42%        0    0.21%    0.22%    1.04%
14: 10000 typeI    TRUE 10   FALSE FALSE        0        0        0    0.12%    0.12%    0.33%
15: 10000 power    TRUE  5   FALSE FALSE    0.03%    0.03%        0    0.04%    0.04%    0.60%
16: 10000 typeI    TRUE  5   FALSE FALSE        0        0        0    0.01%    0.01%    0.09%
17: 10000 power   FALSE  5    TRUE FALSE    0.06%    0.07%        0    0.04%    0.04%    0.63%
18: 10000 typeI   FALSE  5    TRUE FALSE    0.01%    0.01%        0    0.01%    0.01%    0.12%
#+end_example

\clearpage

** 3 stages
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Indicator of reversal
res3stage.reversal <- res3stage[,.(N=.N,
                                   stopInterim = c(.SD[type=="interim"&decision=="stop",reason],"none")[1],
                                   decision = c(.SD[type=="decision",decision],"none")[1],
                                   futility2efficacy = FALSE,
                                   efficacy2futility = FALSE),
                                by = c("method","scenario","seed","missing","binding","fixC","ar","hypo")]
res3stage.reversal[(stopInterim == "futility") & (decision == "efficacy"), futility2efficacy := TRUE]
res3stage.reversal[(stopInterim == "efficacy") & (decision == "futility"), efficacy2futility := TRUE]
#+END_SRC

#+RESULTS:

Percentage of time we observe a reversal:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stageS.reversal <- res3stage.reversal[, .(N = .N,
                                              fu2eff = mean2pc(futility2efficacy),
                                              eff2fu = mean2pc(efficacy2futility)),
                                          by = c("method","scenario","missing","binding","fixC","ar","hypo")]
tablePrint <- dcast(res3stageS.reversal, scenario + N + hypo + missing + ar + binding + fixC ~ method, value.var = c("fu2eff","eff2fu"))
print(tablePrint[order(tablePrint$scenario),.SD,.SDcols = setdiff(names(tablePrint),"scenario")])
#+END_SRC

#+RESULTS:
#+begin_example
        N  hypo missing ar binding  fixC fu2eff_1 fu2eff_2 fu2eff_3 eff2fu_1 eff2fu_2 eff2fu_3
 1: 10000 power    TRUE 10    TRUE FALSE    0.25%    0.25%        0    0.08%    0.08%    0.73%
 2: 10000 typeI    TRUE 10    TRUE FALSE    0.06%    0.06%        0    0.06%    0.06%    0.22%
 3: 10000 typeI    TRUE  5    TRUE FALSE        0        0        0    0.01%    0.01%    0.06%
 4: 10000 power    TRUE 10    TRUE  TRUE    0.04%    0.04%        0    0.54%    0.50%    0.73%
 5: 10000 typeI    TRUE 10    TRUE  TRUE    0.01%    0.01%        0    0.14%    0.14%    0.22%
 6: 10000 power    TRUE  5    TRUE  TRUE        0        0        0    0.36%    0.35%    0.45%
 7: 10000 typeI    TRUE  5    TRUE  TRUE        0        0        0    0.06%    0.06%    0.06%
 8: 10000 power    TRUE 10   FALSE  TRUE    0.05%    0.04%        0    0.47%    0.46%    0.57%
 9:  9990 typeI    TRUE 10   FALSE  TRUE        0        0        0    0.18%    0.18%    0.22%
10: 10000 power    TRUE  5   FALSE  TRUE    0.01%    0.01%        0    0.29%    0.28%    0.32%
11: 10000 typeI    TRUE  5   FALSE  TRUE        0        0        0    0.10%    0.09%    0.11%
12: 10000 power    TRUE 10   FALSE FALSE    0.21%    0.21%        0    0.09%    0.09%    0.57%
13:  9990 typeI    TRUE 10   FALSE FALSE        0        0        0    0.06%    0.06%    0.22%
14: 10000 power    TRUE  5   FALSE FALSE    0.01%    0.01%        0    0.01%    0.01%    0.32%
15: 10000 typeI    TRUE  5   FALSE FALSE        0        0        0        0        0    0.11%
#+end_example


\clearpage

* Logical consistency of p-values/CIs

** Mismatch p-value / boundaries
*** 2 stages

When concluding for futility:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.PmismatchFU <- res2stage[decision=="futility",.(N = .N, mismatch = mean2pc(p.value_MUE<0.025)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res2stageW.PmismatchFU <- dcast(res2stage.PmismatchFU, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res2stageW.PmismatchFU[order(scenario),.SD,.SDcols = setdiff(names(res2stageW.PmismatchFU),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power    TRUE 10    TRUE FALSE        0        0        0
 2: typeI    TRUE 10    TRUE FALSE        0        0        0
 3: power    TRUE  5    TRUE FALSE        0        0        0
 4: typeI    TRUE  5    TRUE FALSE        0        0        0
 5: power    TRUE 10    TRUE  TRUE        0        0        0
 6: typeI    TRUE 10    TRUE  TRUE        0        0        0
 7: power    TRUE  5    TRUE  TRUE        0        0        0
 8: typeI    TRUE  5    TRUE  TRUE        0        0        0
 9: power    TRUE 10   FALSE  TRUE        0        0        0
10: typeI    TRUE 10   FALSE  TRUE        0        0        0
11: power    TRUE  5   FALSE  TRUE        0        0        0
12: typeI    TRUE  5   FALSE  TRUE        0        0        0
13: power    TRUE 10   FALSE FALSE        0        0        0
14: typeI    TRUE 10   FALSE FALSE        0        0        0
15: power    TRUE  5   FALSE FALSE        0        0        0
16: typeI    TRUE  5   FALSE FALSE        0        0        0
17: power   FALSE  5    TRUE FALSE        0        0        0
18: typeI   FALSE  5    TRUE FALSE        0        0        0
#+end_example

When concluding for efficacy:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.PmismatchEFF <- res2stage[decision=="efficacy",.(N = .N, mismatch = mean2pc(p.value_MUE>0.025)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res2stageW.PmismatchEFF <- dcast(res2stage.PmismatchEFF, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res2stageW.PmismatchEFF[order(scenario),.SD,.SDcols = setdiff(names(res2stageW.PmismatchEFF),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power    TRUE 10    TRUE FALSE        0        0        0
 2: typeI    TRUE 10    TRUE FALSE        0        0        0
 3: power    TRUE  5    TRUE FALSE        0        0        0
 4: typeI    TRUE  5    TRUE FALSE        0        0        0
 5: power    TRUE 10    TRUE  TRUE        0        0        0
 6: typeI    TRUE 10    TRUE  TRUE        0        0        0
 7: power    TRUE  5    TRUE  TRUE        0        0        0
 8: typeI    TRUE  5    TRUE  TRUE        0        0        0
 9: power    TRUE 10   FALSE  TRUE        0        0        0
10: typeI    TRUE 10   FALSE  TRUE        0        0        0
11: power    TRUE  5   FALSE  TRUE        0        0        0
12: typeI    TRUE  5   FALSE  TRUE        0        0        0
13: power    TRUE 10   FALSE FALSE        0        0        0
14: typeI    TRUE 10   FALSE FALSE        0        0        0
15: power    TRUE  5   FALSE FALSE        0        0        0
16: typeI    TRUE  5   FALSE FALSE        0        0        0
17: power   FALSE  5    TRUE FALSE        0        0        0
18: typeI   FALSE  5    TRUE FALSE        0        0        0
#+end_example

\clearpage

*** 3 stages

When concluding for futility:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.PmismatchFU <- res3stage[decision=="futility",.(N = .N, mismatch = mean2pc(p.value_MUE<0.025)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res3stageW.PmismatchFU <- dcast(res3stage.PmismatchFU, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res3stageW.PmismatchFU[order(scenario),.SD,.SDcols = setdiff(names(res3stageW.PmismatchFU),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power    TRUE 10    TRUE FALSE        0        0        0
 2: typeI    TRUE 10    TRUE FALSE        0        0        0
 3: power    TRUE  5    TRUE FALSE        0        0        0
 4: typeI    TRUE  5    TRUE FALSE        0        0        0
 5: power    TRUE 10    TRUE  TRUE        0        0    0.04%
 6: typeI    TRUE 10    TRUE  TRUE        0        0        0
 7: power    TRUE  5    TRUE  TRUE        0        0        0
 8: typeI    TRUE  5    TRUE  TRUE        0        0        0
 9: power    TRUE 10   FALSE  TRUE    0.04%    0.04%        0
10: typeI    TRUE 10   FALSE  TRUE        0        0        0
11: power    TRUE  5   FALSE  TRUE        0        0        0
12: typeI    TRUE  5   FALSE  TRUE        0        0        0
13: power    TRUE 10   FALSE FALSE    0.04%        0        0
14: typeI    TRUE 10   FALSE FALSE        0        0        0
15: power    TRUE  5   FALSE FALSE        0        0        0
16: typeI    TRUE  5   FALSE FALSE        0        0        0
17: power   FALSE  5    TRUE FALSE        0        0        0
18: typeI   FALSE  5    TRUE FALSE        0        0        0
#+end_example

When concluding for efficacy:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.PmismatchEFF <- res3stage[decision=="efficacy",.(N = .N, mismatch = mean2pc(p.value_MUE>0.025)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res3stageW.PmismatchEFF <- dcast(res3stage.PmismatchEFF, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res3stageW.PmismatchEFF[order(scenario),.SD,.SDcols = setdiff(names(res3stageW.PmismatchEFF),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power    TRUE 10    TRUE FALSE    0.01%    0.01%        0
 2: typeI    TRUE 10    TRUE FALSE    0.38%        0        0
 3: power    TRUE  5    TRUE FALSE        0        0        0
 4: typeI    TRUE  5    TRUE FALSE        0        0        0
 5: power    TRUE 10    TRUE  TRUE    0.01%        0        0
 6: typeI    TRUE 10    TRUE  TRUE    0.40%        0        0
 7: power    TRUE  5    TRUE  TRUE        0        0        0
 8: typeI    TRUE  5    TRUE  TRUE        0        0        0
 9: power    TRUE 10   FALSE  TRUE        0        0        0
10: typeI    TRUE 10   FALSE  TRUE        0        0        0
11: power    TRUE  5   FALSE  TRUE    0.01%    0.01%        0
12: typeI    TRUE  5   FALSE  TRUE        0        0        0
13: power    TRUE 10   FALSE FALSE        0    0.01%        0
14: typeI    TRUE 10   FALSE FALSE        0        0        0
15: power    TRUE  5   FALSE FALSE    0.01%        0        0
16: typeI    TRUE  5   FALSE FALSE        0        0        0
17: power   FALSE  5    TRUE FALSE        0        0        0
18: typeI   FALSE  5    TRUE FALSE        0        0        0
#+end_example

\clearpage

** Mismatch confidence intervals / boundaries

*** 2 stages 

When concluding for futility:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.CImismatchFU <- res2stage[decision=="futility",.(N = .N, mismatch = mean2pc(lower_MUE>0)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res2stageW.CImismatchFU <- dcast(res2stage.CImismatchFU, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res2stageW.CImismatchFU[order(scenario),.SD,.SDcols = setdiff(names(res2stageW.CImismatchFU),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC       method 1       method 2       method 3
 1: power    TRUE 10    TRUE FALSE              0              0  0 (NA: 0.05%)
 2: typeI    TRUE 10    TRUE FALSE              0              0              0
 3: power    TRUE  5    TRUE FALSE              0              0              0
 4: typeI    TRUE  5    TRUE FALSE              0              0              0
 5: power    TRUE 10    TRUE  TRUE              0              0  0 (NA: 0.05%)
 6: typeI    TRUE 10    TRUE  TRUE              0              0              0
 7: power    TRUE  5    TRUE  TRUE              0              0              0
 8: typeI    TRUE  5    TRUE  TRUE              0              0              0
 9: power    TRUE 10   FALSE  TRUE 0 (NA: 32.62%) 0 (NA: 30.38%) 0 (NA: 31.41%)
10: typeI    TRUE 10   FALSE  TRUE  0 (NA: 0.21%)  0 (NA: 0.19%)  0 (NA: 0.34%)
11: power    TRUE  5   FALSE  TRUE 0 (NA: 30.64%) 0 (NA: 29.26%) 0 (NA: 30.24%)
12: typeI    TRUE  5   FALSE  TRUE  0 (NA: 0.06%)  0 (NA: 0.06%)  0 (NA: 0.09%)
13: power    TRUE 10   FALSE FALSE 0 (NA: 30.41%) 0 (NA: 31.13%) 0 (NA: 31.41%)
14: typeI    TRUE 10   FALSE FALSE  0 (NA: 0.12%)  0 (NA: 0.12%)  0 (NA: 0.34%)
15: power    TRUE  5   FALSE FALSE 0 (NA: 29.09%) 0 (NA: 29.28%) 0 (NA: 30.24%)
16: typeI    TRUE  5   FALSE FALSE  0 (NA: 0.01%)  0 (NA: 0.01%)  0 (NA: 0.09%)
17: power   FALSE  5    TRUE FALSE              0              0              0
18: typeI   FALSE  5    TRUE FALSE              0              0              0
#+end_example

When concluding for efficacy:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.CImismatchEFF <- res2stage[decision=="efficacy",.(N = .N, mismatch = mean2pc(lower_MUE<0)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res2stageW.CImismatchEFF <- dcast(res2stage.CImismatchEFF, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res2stageW.CImismatchEFF[order(scenario),.SD,.SDcols = setdiff(names(res2stageW.CImismatchEFF),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC      method 1      method 2      method 3
 1: power    TRUE 10    TRUE FALSE 0 (NA: 0.02%) 0 (NA: 0.02%) 0 (NA: 0.01%)
 2: typeI    TRUE 10    TRUE FALSE             0             0             0
 3: power    TRUE  5    TRUE FALSE             0             0             0
 4: typeI    TRUE  5    TRUE FALSE             0             0             0
 5: power    TRUE 10    TRUE  TRUE 0 (NA: 0.02%) 0 (NA: 0.02%) 0 (NA: 0.01%)
 6: typeI    TRUE 10    TRUE  TRUE             0             0             0
 7: power    TRUE  5    TRUE  TRUE             0             0             0
 8: typeI    TRUE  5    TRUE  TRUE             0             0             0
 9: power    TRUE 10   FALSE  TRUE 0 (NA: 0.03%) 0 (NA: 0.02%) 0 (NA: 0.01%)
10: typeI    TRUE 10   FALSE  TRUE             0             0             0
11: power    TRUE  5   FALSE  TRUE 0 (NA: 0.01%) 0 (NA: 0.02%) 0 (NA: 0.02%)
12: typeI    TRUE  5   FALSE  TRUE             0             0             0
13: power    TRUE 10   FALSE FALSE 0 (NA: 0.02%) 0 (NA: 0.02%) 0 (NA: 0.01%)
14: typeI    TRUE 10   FALSE FALSE             0             0             0
15: power    TRUE  5   FALSE FALSE 0 (NA: 0.01%) 0 (NA: 0.01%) 0 (NA: 0.02%)
16: typeI    TRUE  5   FALSE FALSE             0             0             0
17: power   FALSE  5    TRUE FALSE 0 (NA: 0.02%) 0 (NA: 0.02%) 0 (NA: 0.03%)
18: typeI   FALSE  5    TRUE FALSE             0             0             0
#+end_example

*** 3 stages 

When concluding for futility:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.CImismatchFU <- res3stage[decision=="futility",.(N = .N, mismatch = mean2pc(lower_MUE>0)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res3stageW.CImismatchFU <- dcast(res3stage.CImismatchFU, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res3stageW.CImismatchFU[order(scenario),.SD,.SDcols = setdiff(names(res3stageW.CImismatchFU),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC          method 1          method 2           method 3
 1: power    TRUE 10    TRUE FALSE 0.04% (NA: 0.12%)     0 (NA: 0.12%)  0.04% (NA: 0.85%)
 2: typeI    TRUE 10    TRUE FALSE     0 (NA: 0.03%)     0 (NA: 0.03%)      0 (NA: 0.09%)
 3: power    TRUE  5    TRUE FALSE             0.08%                 0      0 (NA: 0.42%)
 4: typeI    TRUE  5    TRUE FALSE                 0                 0      0 (NA: 0.01%)
 5: power    TRUE 10    TRUE  TRUE 0.04% (NA: 0.61%) 0.04% (NA: 0.61%)      0 (NA: 0.85%)
 6: typeI    TRUE 10    TRUE  TRUE     0 (NA: 0.07%) 0.01% (NA: 0.07%)  0.01% (NA: 0.09%)
 7: power    TRUE  5    TRUE  TRUE 0.08% (NA: 0.31%)     0 (NA: 0.31%)  0.04% (NA: 0.42%)
 8: typeI    TRUE  5    TRUE  TRUE     0 (NA: 0.01%) 0.01% (NA: 0.01%)      0 (NA: 0.01%)
 9: power    TRUE 10   FALSE  TRUE    0 (NA: 20.21%)    0 (NA: 18.83%)     0 (NA: 19.41%)
10: typeI    TRUE 10   FALSE  TRUE     0 (NA: 0.18%)     0 (NA: 0.18%)      0 (NA: 0.23%)
11: power    TRUE  5   FALSE  TRUE    0 (NA: 19.98%)    0 (NA: 19.51%)     0 (NA: 19.91%)
12: typeI    TRUE  5   FALSE  TRUE     0 (NA: 0.10%)     0 (NA: 0.09%)      0 (NA: 0.11%)
13: power    TRUE 10   FALSE FALSE    0 (NA: 18.51%)    0 (NA: 18.54%)     0 (NA: 19.41%)
14: typeI    TRUE 10   FALSE FALSE     0 (NA: 0.06%)     0 (NA: 0.06%)      0 (NA: 0.23%)
15: power    TRUE  5   FALSE FALSE    0 (NA: 19.10%)    0 (NA: 19.13%) 0.05% (NA: 19.91%)
16: typeI    TRUE  5   FALSE FALSE                 0                 0      0 (NA: 0.11%)
17: power   FALSE  5    TRUE FALSE             0.04%             0.04%      0 (NA: 0.43%)
18: typeI   FALSE  5    TRUE FALSE                 0                 0      0 (NA: 0.02%)
#+end_example

When concluding for efficacy:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.CImismatchEFF <- res3stage[decision=="efficacy",.(N = .N, mismatch = mean2pc(lower_MUE<0)),
                                  by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res3stageW.CImismatchEFF <- dcast(res3stage.CImismatchEFF, scenario + hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
res3stageW.CImismatchEFF[order(scenario),.SD,.SDcols = setdiff(names(res3stageW.CImismatchEFF),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC      method 1      method 2      method 3
 1: power    TRUE 10    TRUE FALSE             0         0.01%             0
 2: typeI    TRUE 10    TRUE FALSE             0             0             0
 3: power    TRUE  5    TRUE FALSE             0             0             0
 4: typeI    TRUE  5    TRUE FALSE             0             0             0
 5: power    TRUE 10    TRUE  TRUE             0         0.01%             0
 6: typeI    TRUE 10    TRUE  TRUE             0             0             0
 7: power    TRUE  5    TRUE  TRUE             0             0             0
 8: typeI    TRUE  5    TRUE  TRUE             0             0             0
 9: power    TRUE 10   FALSE  TRUE             0         0.01% 0 (NA: 0.01%)
10: typeI    TRUE 10   FALSE  TRUE             0             0             0
11: power    TRUE  5   FALSE  TRUE         0.01%             0         0.01%
12: typeI    TRUE  5   FALSE  TRUE             0             0             0
13: power    TRUE 10   FALSE FALSE             0             0 0 (NA: 0.01%)
14: typeI    TRUE 10   FALSE FALSE             0             0             0
15: power    TRUE  5   FALSE FALSE         0.01%             0             0
16: typeI    TRUE  5   FALSE FALSE             0             0             0
17: power   FALSE  5    TRUE FALSE 0 (NA: 0.01%) 0 (NA: 0.01%) 0 (NA: 0.01%)
18: typeI   FALSE  5    TRUE FALSE             0             0             0
#+end_example


*** debug NA (2 stage)                                           :noexport:
This only occurs with method 3 for non-binding futility rules and
concluding futility. Moreover in all occurences, recruitement in the
trial was stopped after the first interim and conclusion was reached at decision:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## find scenario & seed where mismatch occurs
mismatch.scenarseed <- res2stage[decision=="futility" & lower_MUE>0,paste0(scenario,"-",seed)]
## restrict dataset to scenario where mismatch occured
res2stage.mismatch <- res2stage[paste0(scenario,"-",seed) %in% mismatch.scenarseed]
## restrict dataset to method 3 where mismatch occured
res2stage.mismatchM3 <- res2stage.mismatch[method == 3]
## all decisions and reasons
table.decision <- res2stage.mismatchM3[, .N, by = c("stage","type","decision","reason")]
table.decision[,type := factor(type,unique(type))]
setkeyv(table.decision,c("stage","type"))
table.decision
#+END_SRC

#+RESULTS:
:    stage     type decision                       reason   N
: 1:     1  interim     stop                     futility  80
: 2:     1  interim     stop                     efficacy 322
: 3:     1 decision futility stop for futility at interim  16
: 4:     1 decision futility                         <NA> 386
: 5:     2    final     <NA>                         <NA> 402

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stage.mismatchM3[type=="decision",range(ck)]
#+END_SRC

#+RESULTS:
: [1] 1.959964 2.328656

- stopping for efficacy and then experiencing a reversal leading to
  conclude futility. When stopping for efficacy and concluding
  futility method 1 and 2 lead to adjusted p-value of 1 and issues
  when for confidence interval calculation.
#+BEGIN_SRC R :exports both :results output :session *R* :cache no
mismatchE.scenarseed <- res2stage.mismatchM3[stage == 1 & type  == "interim" & reason == "efficacy",paste0(scenario,"-",seed)]


tableE.estimates <- res2stage[paste0(scenario,"-",seed) %in% mismatchE.scenarseed & !is.na(statistic),
                              .(.N,
                                "stat [range]"= ciNA(statistic, 2),
                                "p.value [range]"= ciNA(p.value_MUE, 4),
                                "lower.ci [range]"= ciNA(lower_MUE, 4)),
                              by=c("method","type","decision","reason")]
tableE.estimates[,type := factor(type,c("interim","decision","final"))]
setkeyv(tableE.estimates,c("method","type"))
tableE.estimates
#+END_SRC

#+RESULTS:
#+begin_example
    method     type decision              reason   N stat [range] p.value [range]          lower.ci [range]
 1:      1  interim continue no boundary crossed 100  [2.16;2.48]            <NA>                      <NA>
 2:      1  interim     stop            efficacy 222  [2.31;3.33]            <NA>                      <NA>
 3:      1 decision futility                <NA> 102  [1.61;1.95]           [1;1]  [-0.127;-0.1059] NA = 71
 4:      1 decision efficacy                <NA> 120  [1.64;2.31]  [0.005;0.0114]           [0.0791;0.1859]
 5:      1    final efficacy                <NA>  64  [2.03;4.02] [0.0069;0.0247]            [0.001;0.1405]
 6:      1    final futility                <NA>  36   [0.6;2.02] [0.0256;0.2733]         [-0.2788;-0.0021]
 7:      2  interim continue no boundary crossed 104   [2.16;2.5]            <NA>                      <NA>
 8:      2  interim     stop            efficacy 218  [2.31;3.33]            <NA>                      <NA>
 9:      2 decision futility                <NA>  99  [1.61;1.95]           [1;1] [-0.1414;-0.1063] NA = 70
10:      2 decision efficacy                <NA> 119  [1.64;2.31]  [0.005;0.0113]           [0.0786;0.1858]
11:      2    final efficacy                <NA>  66  [2.03;4.02] [0.0068;0.0247]             [0.001;0.142]
12:      2    final futility                <NA>  38   [0.6;2.02] [0.0255;0.2733]         [-0.2788;-0.0019]
13:      3  interim     stop            efficacy 322  [2.16;3.33]            <NA>                      <NA>
14:      3 decision futility                <NA> 322  [1.61;2.31]      [0.9922;1]           [0.0172;0.6026]
#+end_example

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
mismatchEstop2.scenarseed <- res2stage[paste0(scenario,"-",seed) %in% mismatchE.scenarseed & method == 2 & type == "interim" & decision == "stop", paste0(scenario,"-",seed)]
res2stage[paste0(scenario,"-",seed) %in% mismatchEstop2.scenarseed & method == 2 & type == "decision", paste0(scenario,"-",seed)[1], by = "decision"]
#+END_SRC

#+RESULTS:
:    decision          V1
: 1: futility 9-413883402
: 2: efficacy 9-341365344

- stopping for futility and conclude futility because the test
  statistic is low or in a few cases only because method 3 does not
  allow for a reversal. Method 1 and 2 always stopped for futility and
  either concluded futility or efficacy.
#+BEGIN_SRC R :exports both :results output :session *R* :cache no
mismatchF.scenarseed <- res2stage.mismatchM3[stage == 1 & type  == "interim" & reason == "futility",paste0(scenario,"-",seed)]
tableF.estimates <- res2stage[paste0(scenario,"-",seed) %in% mismatchF.scenarseed & !is.na(statistic),
                              .(.N,
                                "stat [range]"= ciNA(statistic, 2),
                                "p.value [range]"= ciNA(p.value_MUE, 4),
                                "lower.ci [range]"= ciNA(lower_MUE, 4)),
                              by=c("method","type","decision","reason")]
tableF.estimates[,type := factor(type,c("interim","decision","final"))]
setkeyv(tableF.estimates,c("method","type"))
tableF.estimates
#+END_SRC

#+RESULTS:
#+begin_example
   method     type decision                       reason  N stat [range] p.value [range]          lower.ci [range]
1:      1  interim     stop                     futility 80 [-0.14;0.91]            <NA>                      <NA>
2:      1 decision efficacy                         <NA> 37  [1.66;2.65]   [0.0029;0.01]           [0.0937;0.1935]
3:      1 decision futility                         <NA> 43   [1.55;1.9]           [1;1] [-0.1307;-0.1083] NA = 33
4:      2  interim     stop                     futility 80 [-0.14;0.91]            <NA>                      <NA>
5:      2 decision efficacy                         <NA> 35  [1.66;2.65] [0.0029;0.0101]           [0.0927;0.1933]
6:      2 decision futility                         <NA> 45   [1.55;1.9]           [1;1] [-0.1305;-0.1089] NA = 35
7:      3  interim     stop                     futility 80 [-0.14;0.91]            <NA>                      <NA>
8:      3 decision futility stop for futility at interim 16  [1.98;2.65] [0.9937;0.9983]            [0.3614;0.444]
9:      3 decision futility                         <NA> 64  [1.55;2.03]      [0.9971;1]           [0.0115;0.4721]
#+end_example

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stage[paste0(scenario,"-",seed) %in% mismatchF.scenarseed & method == 2 & type == "decision", paste0(scenario,"-",seed)[1], by = "decision"]
#+END_SRC

#+RESULTS:
:    decision          V1
: 1: efficacy 9-996631745
: 2: futility 9-657706742

** Range of p-values

*** 2 stages
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2.stage.rangep <- res2stage[,.(range.p_MUE = paste0("[",paste(round(range(p.value_MUE, na.rm = TRUE),4), collapse = ";"),"]")),
                               by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res2W.stage.rangep <- dcast(res2.stage.rangep, scenario+missing+binding+fixC+ar+hypo~method.char, value.var = "range.p_MUE")
res2W.stage.rangep[order(scenario),.SD,.SDcols = setdiff(names(res2W.stage.rangep),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
    missing binding  fixC ar  hypo       method 1       method 2       method 3
 1:    TRUE    TRUE FALSE 10 power     [0;0.9147]     [0;0.9147]     [0;0.9147]
 2:    TRUE    TRUE FALSE 10 typeI [1e-04;0.9999] [1e-04;0.9999] [1e-04;0.9999]
 3:    TRUE    TRUE FALSE  5 power     [0;0.9015]     [0;0.9015]     [0;0.9015]
 4:    TRUE    TRUE FALSE  5 typeI [1e-04;0.9998] [1e-04;0.9998] [1e-04;0.9998]
 5:    TRUE    TRUE  TRUE 10 power     [0;0.9147]     [0;0.9147]     [0;0.9147]
 6:    TRUE    TRUE  TRUE 10 typeI [2e-04;0.9999] [2e-04;0.9999] [1e-04;0.9999]
 7:    TRUE    TRUE  TRUE  5 power     [0;0.9015]     [0;0.9015]     [0;0.9015]
 8:    TRUE    TRUE  TRUE  5 typeI [3e-04;0.9998] [3e-04;0.9998] [1e-04;0.9998]
 9:    TRUE   FALSE  TRUE 10 power          [0;1]          [0;1]          [0;1]
10:    TRUE   FALSE  TRUE 10 typeI      [1e-04;1]      [1e-04;1]      [1e-04;1]
11:    TRUE   FALSE  TRUE  5 power          [0;1]          [0;1]          [0;1]
12:    TRUE   FALSE  TRUE  5 typeI      [2e-04;1]      [2e-04;1]      [1e-04;1]
13:    TRUE   FALSE FALSE 10 power          [0;1]          [0;1]          [0;1]
14:    TRUE   FALSE FALSE 10 typeI      [1e-04;1]      [1e-04;1]      [1e-04;1]
15:    TRUE   FALSE FALSE  5 power          [0;1]          [0;1]          [0;1]
16:    TRUE   FALSE FALSE  5 typeI          [0;1]          [0;1]      [1e-04;1]
17:   FALSE    TRUE FALSE  5 power     [0;0.9642]     [0;0.9642]     [0;0.9642]
18:   FALSE    TRUE FALSE  5 typeI          [0;1]          [0;1]      [1e-04;1]
#+end_example

\clearpage

*** 3 stages
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3.stage.rangep <- res3stage[,.(range.p_MUE = paste0("[",paste(round(range(p.value_MUE, na.rm = TRUE),4), collapse = ";"),"]")),
                               by = c("method.char","scenario","missing","binding","fixC","ar","hypo")]
res3W.stage.rangep <- dcast(res3.stage.rangep, scenario+missing+binding+fixC+ar+hypo~method.char, value.var = "range.p_MUE")
res3W.stage.rangep[order(scenario),.SD,.SDcols = setdiff(names(res3W.stage.rangep),"scenario")]
#+END_SRC

#+RESULTS:
#+begin_example
    missing binding  fixC ar  hypo       method 1       method 2   method 3
 1:    TRUE    TRUE FALSE 10 power     [0;0.9788]     [0;0.9788] [0;0.9788]
 2:    TRUE    TRUE FALSE 10 typeI      [1e-04;1]      [1e-04;1]  [3e-04;1]
 3:    TRUE    TRUE FALSE  5 power     [0;0.9884]     [0;0.9884] [0;0.9884]
 4:    TRUE    TRUE FALSE  5 typeI      [1e-04;1]      [1e-04;1]  [1e-04;1]
 5:    TRUE    TRUE  TRUE 10 power     [0;0.9788]     [0;0.9788] [0;0.9788]
 6:    TRUE    TRUE  TRUE 10 typeI      [5e-04;1]      [5e-04;1]  [3e-04;1]
 7:    TRUE    TRUE  TRUE  5 power     [0;0.9884]     [0;0.9884] [0;0.9884]
 8:    TRUE    TRUE  TRUE  5 typeI      [7e-04;1]      [7e-04;1]  [1e-04;1]
 9:    TRUE   FALSE  TRUE 10 power          [0;1]          [0;1]      [0;1]
10:    TRUE   FALSE  TRUE 10 typeI      [0.001;1]      [0.001;1]  [8e-04;1]
11:    TRUE   FALSE  TRUE  5 power          [0;1]          [0;1]      [0;1]
12:    TRUE   FALSE  TRUE  5 typeI     [0.0011;1]     [0.0011;1]  [3e-04;1]
13:    TRUE   FALSE FALSE 10 power          [0;1]          [0;1]      [0;1]
14:    TRUE   FALSE FALSE 10 typeI      [4e-04;1]      [4e-04;1]  [8e-04;1]
15:    TRUE   FALSE FALSE  5 power          [0;1]          [0;1]      [0;1]
16:    TRUE   FALSE FALSE  5 typeI [3e-04;0.9998] [3e-04;0.9999]  [3e-04;1]
17:   FALSE    TRUE FALSE  5 power     [0;0.9868]     [0;0.9868] [0;0.9868]
18:   FALSE    TRUE FALSE  5 typeI          [0;1]          [0;1]  [1e-04;1]
#+end_example

\clearpage 

* Coverage

** 2 stages
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.coverage <- res2stage[decision %in% c("futility","efficacy"),
                                .(N = .N,
                                  coverage = mean2pc( (lower_MUE <= truth) & (truth <= upper_MUE))),
                                by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res2stage.coverage, hypo + missing + ar + binding + fixC ~ method.char, value.var = "coverage")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC           method 1           method 2           method 3
 1: power   FALSE  5    TRUE FALSE 94.79% (NA: 0.02%) 94.79% (NA: 0.02%) 95.31% (NA: 0.02%)
 2: power    TRUE  5   FALSE FALSE 95.86% (NA: 5.72%) 95.86% (NA: 5.76%) 95.97% (NA: 5.48%)
 3: power    TRUE  5   FALSE  TRUE 97.77% (NA: 6.16%) 97.76% (NA: 5.86%) 95.97% (NA: 5.48%)
 4: power    TRUE  5    TRUE FALSE             94.73%             94.73%             95.13%
 5: power    TRUE  5    TRUE  TRUE             96.28%             96.32%             95.13%
 6: power    TRUE 10   FALSE FALSE 95.90% (NA: 5.95%) 95.89% (NA: 6.11%) 96.07% (NA: 5.30%)
 7: power    TRUE 10   FALSE  TRUE 97.38% (NA: 6.59%) 97.45% (NA: 6.06%) 96.07% (NA: 5.30%)
 8: power    TRUE 10    TRUE FALSE 94.84% (NA: 0.02%) 94.82% (NA: 0.02%) 95.34% (NA: 0.02%)
 9: power    TRUE 10    TRUE  TRUE 96.26% (NA: 0.02%) 96.31% (NA: 0.02%) 95.34% (NA: 0.02%)
10: typeI   FALSE  5    TRUE FALSE 95.13% (NA: 0.15%) 95.13% (NA: 0.15%) 95.14% (NA: 0.17%)
11: typeI    TRUE  5   FALSE FALSE 94.87% (NA: 0.01%) 94.87% (NA: 0.01%) 94.96% (NA: 0.09%)
12: typeI    TRUE  5   FALSE  TRUE 94.92% (NA: 0.06%) 94.91% (NA: 0.06%) 94.96% (NA: 0.09%)
13: typeI    TRUE  5    TRUE FALSE 94.81% (NA: 0.14%) 94.81% (NA: 0.14%) 94.86% (NA: 0.14%)
14: typeI    TRUE  5    TRUE  TRUE 94.89% (NA: 0.14%) 94.90% (NA: 0.12%) 94.86% (NA: 0.14%)
15: typeI    TRUE 10   FALSE FALSE 95.01% (NA: 0.12%) 95.01% (NA: 0.12%) 95.29% (NA: 0.33%)
16: typeI    TRUE 10   FALSE  TRUE 95.09% (NA: 0.20%) 95.07% (NA: 0.19%) 95.29% (NA: 0.33%)
17: typeI    TRUE 10    TRUE FALSE 95.16% (NA: 0.09%) 95.19% (NA: 0.10%) 95.20% (NA: 0.13%)
18: typeI    TRUE 10    TRUE  TRUE 95.34% (NA: 0.09%) 95.36% (NA: 0.07%) 95.20% (NA: 0.13%)
#+end_example

Average width of the confidence intervals
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.width <- res2stage[decision %in% c("futility","efficacy"),
                             .(N = .N,
                               width.naive = mean(upper_ML-lower_ML, na.rm = TRUE),
                               width.MUE = mean(upper_MUE-lower_MUE, na.rm = TRUE)),
                             by = c("method.char","missing","binding","fixC","ar","hypo")]
res2stage.width[, width.ratio := width.MUE/width.naive]
dcast(res2stage.width, hypo + missing + ar + binding + fixC ~ method.char, value.var = "width.ratio")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power   FALSE  5    TRUE FALSE   1.0517   1.0517    1.053
 2: power    TRUE  5   FALSE FALSE   1.0355   1.0355    1.036
 3: power    TRUE  5   FALSE  TRUE   1.0410   1.0414    1.036
 4: power    TRUE  5    TRUE FALSE   1.0512   1.0512    1.052
 5: power    TRUE  5    TRUE  TRUE   1.0573   1.0571    1.052
 6: power    TRUE 10   FALSE FALSE   1.0465   1.0463    1.046
 7: power    TRUE 10   FALSE  TRUE   1.0531   1.0541    1.046
 8: power    TRUE 10    TRUE FALSE   1.0623   1.0625    1.061
 9: power    TRUE 10    TRUE  TRUE   1.0700   1.0697    1.061
10: typeI   FALSE  5    TRUE FALSE   1.0427   1.0427    1.046
11: typeI    TRUE  5   FALSE FALSE   0.9995   0.9994    1.012
12: typeI    TRUE  5   FALSE  TRUE   0.9994   0.9995    1.012
13: typeI    TRUE  5    TRUE FALSE   1.0412   1.0411    1.045
14: typeI    TRUE  5    TRUE  TRUE   1.0413   1.0420    1.045
15: typeI    TRUE 10   FALSE FALSE   0.9927   0.9926    1.040
16: typeI    TRUE 10   FALSE  TRUE   0.9926   0.9935    1.040
17: typeI    TRUE 10    TRUE FALSE   1.0456   1.0450    1.056
18: typeI    TRUE 10    TRUE  TRUE   1.0457   1.0475    1.056
#+end_example

Average ratio between the length of the MUE CIs vs. the ML CIs
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.length <- res2stage[decision %in% c("futility","efficacy"),
                                .(N = .N,
                                  length_MUE = mean(upper_MUE-lower_MUE, na.rm = TRUE),
                                  length_ML = mean(upper_ML-lower_ML, na.rm = TRUE),
                                  length_ratio = mean((upper_MUE-lower_MUE)/(upper_ML-lower_ML), na.rm = TRUE)),
                                by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res2stage.length, hypo + missing + ar + binding + fixC ~ method.char, value.var = "length_ratio")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power   FALSE  5    TRUE FALSE   1.0553   1.0553    1.056
 2: power    TRUE  5   FALSE FALSE   1.0476   1.0476    1.049
 3: power    TRUE  5   FALSE  TRUE   1.0530   1.0529    1.049
 4: power    TRUE  5    TRUE FALSE   1.0555   1.0556    1.056
 5: power    TRUE  5    TRUE  TRUE   1.0608   1.0605    1.056
 6: power    TRUE 10   FALSE FALSE   1.0534   1.0533    1.053
 7: power    TRUE 10   FALSE  TRUE   1.0601   1.0605    1.053
 8: power    TRUE 10    TRUE FALSE   1.0640   1.0643    1.062
 9: power    TRUE 10    TRUE  TRUE   1.0710   1.0706    1.062
10: typeI   FALSE  5    TRUE FALSE   1.0489   1.0488    1.053
11: typeI    TRUE  5   FALSE FALSE   0.9994   0.9994    1.013
12: typeI    TRUE  5   FALSE  TRUE   0.9995   0.9996    1.013
13: typeI    TRUE  5    TRUE FALSE   1.0478   1.0478    1.052
14: typeI    TRUE  5    TRUE  TRUE   1.0479   1.0487    1.052
15: typeI    TRUE 10   FALSE FALSE   0.9928   0.9926    1.041
16: typeI    TRUE 10   FALSE  TRUE   0.9928   0.9937    1.041
17: typeI    TRUE 10    TRUE FALSE   1.0492   1.0486    1.060
18: typeI    TRUE 10    TRUE  TRUE   1.0493   1.0511    1.060
#+end_example

\clearpage

** 3 stages
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.coverage <- res3stage[decision %in% c("futility","efficacy"),
                                .(N = .N,
                                  coverage = mean2pc( (lower_MUE <= truth) & (truth <= upper_MUE))),
                                by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res3stage.coverage, hypo + missing + ar + binding + fixC ~ method.char, value.var = "coverage")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC           method 1           method 2           method 3
 1: power   FALSE  5    TRUE FALSE 94.87% (NA: 0.01%) 94.88% (NA: 0.01%) 95.92% (NA: 0.01%)
 2: power    TRUE  5   FALSE FALSE 95.87% (NA: 4.85%) 95.89% (NA: 4.86%) 96.70% (NA: 4.80%)
 3: power    TRUE  5   FALSE  TRUE 98.24% (NA: 5.13%) 98.24% (NA: 5.00%) 96.68% (NA: 4.79%)
 4: power    TRUE  5    TRUE FALSE             94.63%             94.63% 95.59% (NA: 0.02%)
 5: power    TRUE  5    TRUE  TRUE             96.76%             96.74% 95.58% (NA: 0.02%)
 6: power    TRUE 10   FALSE FALSE 96.02% (NA: 4.78%) 96.01% (NA: 4.79%) 96.77% (NA: 4.36%)
 7: power    TRUE 10   FALSE  TRUE 97.96% (NA: 5.25%) 97.95% (NA: 4.88%) 96.73% (NA: 4.36%)
 8: power    TRUE 10    TRUE FALSE 95.05% (NA: 0.09%) 95.05% (NA: 0.09%) 95.91% (NA: 0.01%)
 9: power    TRUE 10    TRUE  TRUE 96.72% (NA: 0.04%) 96.76% (NA: 0.04%) 95.90% (NA: 0.01%)
10: typeI   FALSE  5    TRUE FALSE 94.95% (NA: 0.04%) 94.95% (NA: 0.04%) 95.02% (NA: 0.07%)
11: typeI    TRUE  5   FALSE FALSE             95.00%             95.04% 95.09% (NA: 0.11%)
12: typeI    TRUE  5   FALSE  TRUE 95.10% (NA: 0.10%) 95.12% (NA: 0.09%) 95.11% (NA: 0.11%)
13: typeI    TRUE  5    TRUE FALSE 94.94% (NA: 0.04%) 94.94% (NA: 0.04%) 94.96% (NA: 0.05%)
14: typeI    TRUE  5    TRUE  TRUE 94.99% (NA: 0.05%) 94.99% (NA: 0.05%) 94.96% (NA: 0.05%)
15: typeI    TRUE 10   FALSE FALSE 95.02% (NA: 0.06%) 95.04% (NA: 0.06%) 95.20% (NA: 0.22%)
16: typeI    TRUE 10   FALSE  TRUE 95.14% (NA: 0.18%) 95.13% (NA: 0.18%) 95.17% (NA: 0.22%)
17: typeI    TRUE 10    TRUE FALSE 94.81% (NA: 0.11%) 94.81% (NA: 0.11%) 94.92% (NA: 0.19%)
18: typeI    TRUE 10    TRUE  TRUE 94.94% (NA: 0.15%) 94.90% (NA: 0.15%) 94.91% (NA: 0.18%)
#+end_example

Average width of the confidence intervals
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.width <- res3stage[decision %in% c("futility","efficacy"),
                             .(N = .N,
                               width.naive = mean(upper_ML-lower_ML, na.rm = TRUE),
                               width.MUE = mean(upper_MUE-lower_MUE, na.rm = TRUE)),
                             by = c("method.char","missing","binding","fixC","ar","hypo")]
res3stage.width[, width.ratio := width.MUE/width.naive]
dcast(res3stage.width, hypo + missing + ar + binding + fixC ~ method.char, value.var = "width.ratio")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power   FALSE  5    TRUE FALSE   1.0589   1.0590   1.0601
 2: power    TRUE  5   FALSE FALSE   1.0454   1.0454   1.0468
 3: power    TRUE  5   FALSE  TRUE   1.0497   1.0497   1.0469
 4: power    TRUE  5    TRUE FALSE   1.0611   1.0611   1.0622
 5: power    TRUE  5    TRUE  TRUE   1.0656   1.0651   1.0622
 6: power    TRUE 10   FALSE FALSE   1.0702   1.0703   1.0740
 7: power    TRUE 10   FALSE  TRUE   1.0765   1.0766   1.0740
 8: power    TRUE 10    TRUE FALSE   1.0854   1.0855   1.0888
 9: power    TRUE 10    TRUE  TRUE   1.0923   1.0909   1.0888
10: typeI   FALSE  5    TRUE FALSE   1.0850   1.0850   1.0860
11: typeI    TRUE  5   FALSE FALSE   0.9966   0.9967   0.9991
12: typeI    TRUE  5   FALSE  TRUE   0.9964   0.9965   0.9994
13: typeI    TRUE  5    TRUE FALSE   1.0840   1.0840   1.0853
14: typeI    TRUE  5    TRUE  TRUE   1.0841   1.0838   1.0853
15: typeI    TRUE 10   FALSE FALSE   0.9938   0.9937   1.0070
16: typeI    TRUE 10   FALSE  TRUE   0.9936   0.9939   1.0071
17: typeI    TRUE 10    TRUE FALSE   1.1229   1.1230   1.1275
18: typeI    TRUE 10    TRUE  TRUE   1.1230   1.1218   1.1275
#+end_example

Average ratio between the length of the MUE CIs vs. the ML CIs
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res3stage.length <- res3stage[decision %in% c("futility","efficacy"),
                                .(N = .N,
                                  length_MUE = mean(upper_MUE-lower_MUE, na.rm = TRUE),
                                  length_ML = mean(upper_ML-lower_ML, na.rm = TRUE),
                                  length_ratio = mean((upper_MUE-lower_MUE)/(upper_ML-lower_ML), na.rm = TRUE)),
                                by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res3stage.length, hypo + missing + ar + binding + fixC ~ method.char, value.var = "length_ratio")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power   FALSE  5    TRUE FALSE   1.0578   1.0579   1.0589
 2: power    TRUE  5   FALSE FALSE   1.0530   1.0530   1.0543
 3: power    TRUE  5   FALSE  TRUE   1.0564   1.0562   1.0543
 4: power    TRUE  5    TRUE FALSE   1.0606   1.0606   1.0617
 5: power    TRUE  5    TRUE  TRUE   1.0639   1.0634   1.0617
 6: power    TRUE 10   FALSE FALSE   1.0725   1.0726   1.0755
 7: power    TRUE 10   FALSE  TRUE   1.0779   1.0775   1.0756
 8: power    TRUE 10    TRUE FALSE   1.0825   1.0826   1.0856
 9: power    TRUE 10    TRUE  TRUE   1.0883   1.0870   1.0856
10: typeI   FALSE  5    TRUE FALSE   1.0879   1.0879   1.0891
11: typeI    TRUE  5   FALSE FALSE   0.9964   0.9965   0.9993
12: typeI    TRUE  5   FALSE  TRUE   0.9964   0.9965   0.9996
13: typeI    TRUE  5    TRUE FALSE   1.0880   1.0880   1.0894
14: typeI    TRUE  5    TRUE  TRUE   1.0880   1.0877   1.0894
15: typeI    TRUE 10   FALSE FALSE   0.9938   0.9937   1.0074
16: typeI    TRUE 10   FALSE  TRUE   0.9937   0.9941   1.0075
17: typeI    TRUE 10    TRUE FALSE   1.1230   1.1232   1.1279
18: typeI    TRUE 10    TRUE  TRUE   1.1231   1.1216   1.1279
#+end_example

\clearpage

* Percentage of missing values (2 stages)

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stage.nXinterim <- res2stage[,.(N = .N, nX1 = unique(nX1.interim), nX2 = unique(nX2.interim), nX3 = unique(nX3.interim)),
                                 by = c("method","missing","ar","seed","binding","fixC","hypo")]
all(res2stage.nXinterim$N==3)

res2stageS.nXinterim <- res2stage.nXinterim[, .(N = .N,
                                                pc.all = 100*mean(nX3/nX1),
                                                pc.missing3 = 100*mean(nX2/nX1-nX3/nX1),
                                                pc.missing23 = 100*mean(1-nX2/nX1)),
                                            by = c("method","missing","ar","hypo","fixC","binding")]

setkeyv(res2stageS.nXinterim,"ar")
#+END_SRC

#+RESULTS:
: [1] FALSE

At the first interim
- =pc.all= percentage of observations with full data (with respect to
  all observations, i.e. patients with baseline measurement)
- =pc.missing3= percentage of observations missing the final outcome
  but with intermediate outcome value and baseline.
- =pc.missing23= percentage of observations with only baseline value

Here only for method 1 - values are very similar between different
methods:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stageS.nXinterim[method==1]
#+END_SRC

#+RESULTS:
#+begin_example
    method missing ar  hypo  fixC binding     N pc.all pc.missing3 pc.missing23
 1:      1    TRUE  5 power FALSE    TRUE 10000  79.52       9.591       10.888
 2:      1    TRUE  5 typeI FALSE    TRUE 10000  79.52       9.591       10.888
 3:      1    TRUE  5 power  TRUE    TRUE 10000  79.52       9.591       10.888
 4:      1    TRUE  5 typeI  TRUE    TRUE 10000  79.52       9.591       10.888
 5:      1    TRUE  5 power  TRUE   FALSE 10000  79.64       9.442       10.914
 6:      1    TRUE  5 typeI  TRUE   FALSE 10000  79.64       9.442       10.914
 7:      1    TRUE  5 power FALSE   FALSE 10000  79.64       9.442       10.914
 8:      1    TRUE  5 typeI FALSE   FALSE 10000  79.64       9.442       10.914
 9:      1   FALSE  5 power FALSE    TRUE 10000  87.79       6.090        6.121
10:      1   FALSE  5 typeI FALSE    TRUE 10000  87.79       6.090        6.121
11:      1    TRUE 10 power FALSE    TRUE 10000  71.60      13.354       15.049
12:      1    TRUE 10 typeI FALSE    TRUE 10000  71.60      13.354       15.049
13:      1    TRUE 10 power  TRUE    TRUE 10000  71.60      13.354       15.049
14:      1    TRUE 10 typeI  TRUE    TRUE 10000  71.60      13.354       15.049
15:      1    TRUE 10 power  TRUE   FALSE 10000  71.80      13.162       15.042
16:      1    TRUE 10 typeI  TRUE   FALSE 10000  71.80      13.162       15.042
17:      1    TRUE 10 power FALSE   FALSE 10000  71.80      13.162       15.042
18:      1    TRUE 10 typeI FALSE   FALSE 10000  71.80      13.162       15.042
#+end_example

\clearpage

* Information (2 stages)

Percentage of information for method 1[fn::average over the reached stages]:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
dt.info <- res2stage[,.(.N, infoPC = 100*mean(infoPC, na.rm = TRUE)),
                     by = c("type","method.char","scenario","missing","binding","fixC","ar","hypo")]
dt.info[, type := factor(type, c("interim","decision","final"))]
tablePrint <- dcast(dt.info[method.char == "method 1"],
                    scenario + missing + binding + fixC + ar ~ type,
                    value.var = "infoPC")
print(tablePrint, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario missing binding  fixC ar interim decision  final
        1    TRUE    TRUE FALSE 10   54.64    75.34 102.70
        2    TRUE    TRUE FALSE 10   54.64    74.98 102.37
        3    TRUE    TRUE FALSE  5   53.27    64.04 102.74
        4    TRUE    TRUE FALSE  5   53.27    63.58 102.37
        5    TRUE    TRUE  TRUE 10   54.64    75.34 102.70
        6    TRUE    TRUE  TRUE 10   54.64    74.98 102.37
        7    TRUE    TRUE  TRUE  5   53.27    64.04 102.74
        8    TRUE    TRUE  TRUE  5   53.27    63.58 102.37
        9    TRUE   FALSE  TRUE 10   54.50    74.96 102.54
       10    TRUE   FALSE  TRUE 10   54.50    75.17 103.13
       11    TRUE   FALSE  TRUE  5   53.16    63.72 102.63
       12    TRUE   FALSE  TRUE  5   53.16    64.61 103.13
       13    TRUE   FALSE FALSE 10   54.50    74.96 102.54
       14    TRUE   FALSE FALSE 10   54.50    75.17 103.13
       15    TRUE   FALSE FALSE  5   53.16    63.72 102.63
       16    TRUE   FALSE FALSE  5   53.16    64.61 103.13
       17   FALSE    TRUE FALSE  5   52.07    63.77  99.97
       18   FALSE    TRUE FALSE  5   52.07    63.22  99.63
#+end_example

Similar results for other methods.

# @@latex:any arbitrary LaTeX code@@

* TOFIX :noexport:


* CONFIG :noexport:
# #+LaTeX_HEADER:\affil{Department of Biostatistics, University of Copenhagen, Copenhagen, Denmark}
#+LANGUAGE:  en
#+LaTeX_CLASS: org-article
#+LaTeX_CLASS_OPTIONS: [12pt]
#+OPTIONS:   title:t author:t toc:nil todo:nil
#+OPTIONS:   H:3 num:t 
#+OPTIONS:   TeX:t LaTeX:t
#+LATEX_HEADER: %
#+LATEX_HEADER: %%%% specifications %%%%
#+LATEX_HEADER: %
** Latex command
#+LATEX_HEADER: \usepackage{ifthen}
#+LATEX_HEADER: \usepackage{xifthen}
#+LATEX_HEADER: \usepackage{xargs}
#+LATEX_HEADER: \usepackage{xspace}
#+LATEX_HEADER: \newcommand\Rlogo{\textbf{\textsf{R}}\xspace} % 
** Notations

** Code
# Documentation at https://org-babel.readthedocs.io/en/latest/header-args/#results
# :tangle (yes/no/filename) extract source code with org-babel-tangle-file, see http://orgmode.org/manual/Extracting-source-code.html 
# :cache (yes/no)
# :eval (yes/no/never)
# :results (value/output/silent/graphics/raw/latex)
# :export (code/results/none/both)
#+PROPERTY: header-args :session *R* :tangle yes :cache no ## extra argument need to be on the same line as :session *R*
# Code display:
#+LATEX_HEADER: \RequirePackage{fancyvrb}
#+LATEX_HEADER: \DefineVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\small,formatcom = {\color[rgb]{0.5,0,0}}}
# ## change font size input
# ## #+ATTR_LATEX: :options basicstyle=\ttfamily\scriptsize
# ## change font size output
# ## \RecustomVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\tiny,formatcom = {\color[rgb]{0.5,0,0}}}
** Display 
#+LATEX_HEADER: \RequirePackage{colortbl} % arrayrulecolor to mix colors
#+LATEX_HEADER: \RequirePackage{setspace} % to modify the space between lines - incompatible with footnote in beamer
#+LaTeX_HEADER:\renewcommand{\baselinestretch}{1.1}
#+LATEX_HEADER:\geometry{top=2cm,bottom=3cm,left=1.5cm,right=1.5cm}
#+LATEX_HEADER: \RequirePackage{changepage}

#+LATEX_HEADER: \RequirePackage{colortbl} % arrayrulecolor to mix colors
# ## valid and cross symbols
#+LaTeX_HEADER: \RequirePackage{pifont}
#+LaTeX_HEADER: \RequirePackage{relsize}
#+LaTeX_HEADER: \newcommand{\Cross}{{\raisebox{-0.5ex}%
#+LaTeX_HEADER:		{\relsize{1.5}\ding{56}}}\hspace{1pt} }
#+LaTeX_HEADER: \newcommand{\Valid}{{\raisebox{-0.5ex}%
#+LaTeX_HEADER:		{\relsize{1.5}\ding{52}}}\hspace{1pt} }
#+LaTeX_HEADER: \newcommand{\CrossR}{ \textcolor{red}{\Cross} }
#+LaTeX_HEADER: \newcommand{\ValidV}{ \textcolor{green}{\Valid} }
# ## warning symbol
#+LaTeX_HEADER: \usepackage{stackengine}
#+LaTeX_HEADER: \usepackage{scalerel}
#+LaTeX_HEADER: \newcommand\Warning[1][3ex]{%
#+LaTeX_HEADER:   \renewcommand\stacktype{L}%
#+LaTeX_HEADER:   \scaleto{\stackon[1.3pt]{\color{red}$\triangle$}{\tiny\bfseries !}}{#1}%
#+LaTeX_HEADER:   \xspace
#+LaTeX_HEADER: }
# # change the color of the links
#+LaTeX_HEADER: \hypersetup{
#+LaTeX_HEADER:  citecolor=[rgb]{0,0.5,0},
#+LaTeX_HEADER:  urlcolor=[rgb]{0,0,0.5},
#+LaTeX_HEADER:  linkcolor=[rgb]{0,0,0.5},
#+LaTeX_HEADER: }
** Image
#+LATEX_HEADER: \RequirePackage{epstopdf} % to be able to convert .eps to .pdf image files
#+LATEX_HEADER: \RequirePackage{capt-of} % 
#+LATEX_HEADER: \RequirePackage{caption} % newlines in graphics
** List
#+LATEX_HEADER: \RequirePackage{enumitem} % to be able to convert .eps to .pdf image files
** Color
#+LaTeX_HEADER: \definecolor{light}{rgb}{1, 1, 0.9}
#+LaTeX_HEADER: \definecolor{lightred}{rgb}{1.0, 0.7, 0.7}
#+LaTeX_HEADER: \definecolor{lightblue}{rgb}{0.0, 0.8, 0.8}
#+LaTeX_HEADER: \newcommand{\darkblue}{blue!80!black}
#+LaTeX_HEADER: \newcommand{\darkgreen}{green!50!black}
#+LaTeX_HEADER: \newcommand{\darkred}{red!50!black}
** Box
#+LATEX_HEADER: \usepackage{mdframed}
** Shortcut
#+LATEX_HEADER: \newcommand{\first}{1\textsuperscript{st} }
#+LATEX_HEADER: \newcommand{\second}{2\textsuperscript{nd} }
#+LATEX_HEADER: \newcommand{\third}{3\textsuperscript{rd} }
