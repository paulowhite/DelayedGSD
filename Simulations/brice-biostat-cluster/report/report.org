#+TITLE: Results simulation study DelayedGSD
#+Author: 

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
# Path
if(Sys.info()["login"] == "bozenne"){
  setwd("~/Dropbox/PostDoc/Teaching/Epidemiological_method_in_medical_research_2023/01-12")
}else if(Sys.info()["login"] == "hpl802"){
  setwd("x:/DelayedGSD/")
}
options(width = 110)

library(data.table)
library(ggplot2)
#+END_SRC

#+RESULTS:


#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Load results
res2stage <- readRDS(file.path("Results-built","res2stage.rds"))
res2stage[, method.char := paste0("method ",method)]
res2stage[, stage.char := factor(stage, 1:2, c("interim","final"))]
#+END_SRC

* Rejection rate

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## For each run, create a binary indicator for rejection for efficacy
res2stage.rejection <- res2stage[,.(N = .N, rejection = "efficacy" %in% na.omit(decision)),
                                 by = c("method.char","seed","scenario","missing","binding","fixC","ar","hypo")]

## Average over runs and method within scenario
res2stageS.rejection <- res2stage.rejection[,.(N = .N, rejectionRate = 100*mean(rejection)),
                                            by=c("method.char","scenario","binding","missing","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:
: Fejl i eval(bysub, x, parent.frame()) : 
:   objekt 'scenario' blev ikke fundet

Power by method (columns) and scenario (rows): \hfill (nominal level 0.8)
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrintH1 <- dcast(res2stageS.rejection[hypo=="power"],
                      scenario + N + missing + binding + fixC + ar ~ method.char,
                      value.var = "rejectionRate")
print(tablePrintH1, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario     N missing binding  fixC ar method 1 method 2 method 3
        1 10000    TRUE    TRUE FALSE 10    81.00    80.79    80.45
        3 10000    TRUE    TRUE FALSE  5    80.60    80.45    80.21
        5 10000    TRUE    TRUE  TRUE 10    79.81    80.41    80.39
        7 10000    TRUE    TRUE  TRUE  5    80.00    80.46    80.08
        9 10000    TRUE   FALSE  TRUE 10    80.50    80.85    80.91
       11 10000    TRUE   FALSE  TRUE  5    80.73    80.82    80.75
       13 10000    TRUE   FALSE FALSE 10    80.67    80.60    80.65
       15 10000    TRUE   FALSE FALSE  5    80.65    80.64    80.46
       17 10000   FALSE    TRUE FALSE  5    80.31    80.28    79.93
#+end_example
\Warning slightly too high power for some scenario

\bigskip

Type 1 error by method (columns) and scenario (rows): \hfill (nominal level 0.025)
#+BEGIN_SRC R :exports both :results output :session *R* :cache no
tablePrintH0 <- dcast(res2stageS.rejection[hypo=="typeI"],
                    scenario + N + missing + binding + fixC + ar ~ method.char,
                    value.var = "rejectionRate")
print(tablePrintH0, row.names = FALSE)
#+END_SRC

#+RESULTS:
#+begin_example
 scenario     N missing binding  fixC ar method 1 method 2 method 3
        2 10000    TRUE    TRUE FALSE 10     2.46     2.53     2.40
        4 10000    TRUE    TRUE FALSE  5     2.42     2.41     2.40
        6 10000    TRUE    TRUE  TRUE 10     2.25     2.25     2.45
        8 10000    TRUE    TRUE  TRUE  5     2.42     2.39     2.50
       10 10000    TRUE   FALSE  TRUE 10     2.09     2.09     2.26
       12 10000    TRUE   FALSE  TRUE  5     2.30     2.28     2.33
       14 10000    TRUE   FALSE FALSE 10     2.29     2.28     2.46
       16 10000    TRUE   FALSE FALSE  5     2.38     2.37     2.46
       18 10000   FALSE    TRUE FALSE  5     2.46     2.44     2.45
#+end_example
\Warning slightly too lower type 1 error for some scenario

\clearpage

* Conclusion of the trial

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stageS.final <- res2stage[!is.na(statistic) & type != "interim",
                              .(.N,
                                decision.eff = 100*mean((stage == 1)*(decision == "efficacy")),
                                decision.fut = 100*mean((stage == 1)*(decision == "futility")),
                                final.eff = 100*mean((stage == 2)*(decision == "efficacy")),
                                final.fut = 100*mean((stage == 2)*(decision == "futility"))),
                              by = c("scenario","missing","method","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:

Relative frequency of stopping for efficacy/futility at decision/final

- Method 1
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==1], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_1","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10        37.82        6.050     43.18      13.0
 2: 10000    TRUE typeI    TRUE FALSE 10         0.79       70.850      1.67      26.7
 3: 10000    TRUE power    TRUE FALSE  5        35.60        6.020     45.00      13.4
 4: 10000    TRUE typeI    TRUE FALSE  5         0.68       69.210      1.74      28.4
 5: 10000    TRUE power    TRUE  TRUE 10        36.45        6.530     43.36      13.7
 6: 10000    TRUE typeI    TRUE  TRUE 10         0.64       71.290      1.61      26.5
 7: 10000    TRUE power    TRUE  TRUE  5        34.68        5.860     45.32      14.1
 8: 10000    TRUE typeI    TRUE  TRUE  5         0.72       69.110      1.70      28.5
 9: 10000    TRUE power   FALSE  TRUE 10        37.57        6.630     42.93      12.9
10:  2870    TRUE typeI   FALSE  TRUE 10         1.99        0.976      5.30      91.7
11: 10000    TRUE power   FALSE  TRUE  5        36.02        6.280     44.71      13.0
12:  3043    TRUE typeI   FALSE  TRUE  5         2.40        0.296      5.16      92.1
13: 10000    TRUE power   FALSE FALSE 10        38.32        5.870     42.35      13.5
14:  2874    TRUE typeI   FALSE FALSE 10         2.40        0.313      5.57      91.7
15: 10000    TRUE power   FALSE FALSE  5        36.75        5.700     43.90      13.6
16:  3080    TRUE typeI   FALSE FALSE  5         2.18        0.000      5.55      92.3
17: 10000   FALSE power    TRUE FALSE  5        33.98        5.330     46.33      14.4
18: 10000   FALSE typeI    TRUE FALSE  5         0.74       67.480      1.72      30.1
#+end_example
\Warning something is not quite right for non-binding scenarios under the null (=N= should be 10000).

\clearpage

Method 2:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==2], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_2","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC

#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10        37.66       6.2200     43.13      13.0
 2: 10000    TRUE typeI    TRUE FALSE 10         0.85      71.1800      1.68      26.3
 3: 10000    TRUE power    TRUE FALSE  5        35.55       6.1000     44.90      13.5
 4: 10000    TRUE typeI    TRUE FALSE  5         0.67      69.0500      1.74      28.5
 5: 10000    TRUE power    TRUE  TRUE 10        36.82       5.9400     43.59      13.6
 6: 10000    TRUE typeI    TRUE  TRUE 10         0.63      70.0200      1.62      27.7
 7: 10000    TRUE power    TRUE  TRUE  5        35.06       5.6300     45.40      13.9
 8: 10000    TRUE typeI    TRUE  TRUE  5         0.71      68.4600      1.68      29.1
 9: 10000    TRUE power   FALSE  TRUE 10        37.76       6.2100     43.09      12.9
10:  2956    TRUE typeI   FALSE  TRUE 10         1.89       0.8796      5.18      92.1
11: 10000    TRUE power   FALSE  TRUE  5        36.07       6.1000     44.75      13.1
12:  3093    TRUE typeI   FALSE  TRUE  5         2.33       0.2263      5.04      92.4
13: 10000    TRUE power   FALSE FALSE 10        38.33       6.1100     42.27      13.3
14:  2820    TRUE typeI   FALSE FALSE 10         2.45       0.3191      5.64      91.6
15: 10000    TRUE power   FALSE FALSE  5        36.78       5.7200     43.86      13.6
16:  3075    TRUE typeI   FALSE FALSE  5         2.15       0.0325      5.56      92.3
17: 10000   FALSE power    TRUE FALSE  5        33.68       5.1700     46.60      14.5
18: 10000   FALSE typeI    TRUE FALSE  5         0.72      67.4200      1.72      30.1
#+end_example
\Warning something is not quite right for non-binding scenarios under the null (=N= should be 10000).

\clearpage

Method 3:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.final[method==3], scenario + N + missing + hypo + binding + fixC + ar ~ method,
                    value.var = c("decision.eff","decision.fut","final.eff","final.fut"))
names(tablePrint) <- gsub("_3","",names(tablePrint),fixed = TRUE)
setkeyv(tablePrint,"scenario")
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC
#+RESULTS:
#+begin_example
        N missing  hypo binding  fixC ar decision.eff decision.fut final.eff final.fut
 1: 10000    TRUE power    TRUE FALSE 10        40.44        6.540     40.01      13.0
 2: 10000    TRUE typeI    TRUE FALSE 10         0.74       68.770      1.66      28.8
 3: 10000    TRUE power    TRUE FALSE  5        36.49        6.420     43.72      13.4
 4: 10000    TRUE typeI    TRUE FALSE  5         0.68       68.370      1.72      29.2
 5: 10000    TRUE power    TRUE  TRUE 10        39.85        5.830     40.54      13.8
 6: 10000    TRUE typeI    TRUE  TRUE 10         0.73       68.890      1.72      28.7
 7: 10000    TRUE power    TRUE  TRUE  5        35.70        5.810     44.38      14.1
 8: 10000    TRUE typeI    TRUE  TRUE  5         0.78       68.260      1.72      29.2
 9: 10000    TRUE power   FALSE  TRUE 10        41.03        6.390     39.88      12.7
10:  3086    TRUE typeI   FALSE  TRUE 10         2.33        1.231      4.99      91.4
11: 10000    TRUE power   FALSE  TRUE  5        37.08        6.140     43.67      13.1
12:  3133    TRUE typeI   FALSE  TRUE  5         2.36        0.447      5.08      92.1
13: 10000    TRUE power   FALSE FALSE 10        41.47        6.050     39.18      13.3
14:  3130    TRUE typeI   FALSE FALSE 10         2.59        0.990      5.27      91.2
15: 10000    TRUE power   FALSE FALSE  5        37.37        5.860     43.09      13.7
16:  3163    TRUE typeI   FALSE FALSE  5         2.37        0.253      5.41      92.0
17: 10000   FALSE power    TRUE FALSE  5        34.66        5.580     45.27      14.5
18: 10000   FALSE typeI    TRUE FALSE  5         0.68       66.540      1.77      31.0
#+end_example
\Warning something is not quite right for non-binding scenarios under the null (=N= should be 10000).

\clearpage

* Bias

True effect: 0.6
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
true_eff <- 0.6

## For each run, error made by each estimator
res2stage[, truth := c(0,true_eff)[(hypo=="power")+1]]
res2stage.bias <- res2stage[decision %in% c("futility","efficacy"),
                            .(N = .N,
                              bias_MLE = estimate_ML-truth,
                              bias_MUE = (estimate_MUE>truth) - 0.5),
                            by = c("method","scenario","seed","missing","binding","fixC","ar","hypo")]
all(res2stage.bias$N==1)

res2stageS.bias <- res2stage.bias[,.(N = .N,
                                     bias_MLE = mean(bias_MLE, na.rm = TRUE),
                                     bias_MUE = mean(bias_MUE, na.rm = TRUE)),
                                  by=c("method","scenario","missing","binding","fixC","ar","hypo")]
#+END_SRC

#+RESULTS:
: [1] TRUE

Bias per estimator and method:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
tablePrint <- dcast(res2stageS.bias,
                    hypo + scenario + missing + binding + fixC + ar ~ method,
                    value.var = c("bias_MLE","bias_MUE"))
setkeyv(tablePrint,"scenario")
names(tablePrint) <- gsub("_","",names(tablePrint),fixed = TRUE)
print(tablePrint[,.SD,.SDcols = setdiff(names(tablePrint),"scenario")], digits = 3)
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing binding  fixC ar biasMLE1 biasMLE2 biasMLE3 biasMUE1 biasMUE2 biasMUE3
 1: power    TRUE    TRUE FALSE 10   0.0130   0.0131   0.0141  -0.0023  -0.0017  -0.0042
 2: typeI    TRUE    TRUE FALSE 10  -0.0184  -0.0184  -0.0185   0.0002  -0.0013   0.0001
 3: power    TRUE    TRUE FALSE  5   0.0224   0.0222   0.0234  -0.0030  -0.0016  -0.0018
 4: typeI    TRUE    TRUE FALSE  5  -0.0304  -0.0308  -0.0306   0.0000  -0.0002   0.0001
 5: power    TRUE    TRUE  TRUE 10   0.0116   0.0121   0.0130  -0.0053  -0.0061  -0.0080
 6: typeI    TRUE    TRUE  TRUE 10  -0.0221  -0.0223  -0.0223  -0.0113  -0.0079  -0.0099
 7: power    TRUE    TRUE  TRUE  5   0.0216   0.0220   0.0227  -0.0073  -0.0075  -0.0075
 8: typeI    TRUE    TRUE  TRUE  5  -0.0339  -0.0344  -0.0341  -0.0105  -0.0081  -0.0105
 9: power    TRUE   FALSE  TRUE 10   0.0150   0.0151   0.0163  -0.0025  -0.0044  -0.0036
10: typeI    TRUE   FALSE  TRUE 10   0.1776   0.1740   0.1713   0.3606   0.3562   0.3487
11: power    TRUE   FALSE  TRUE  5   0.0242   0.0242   0.0252  -0.0014  -0.0012  -0.0026
12: typeI    TRUE   FALSE  TRUE  5   0.1722   0.1701   0.1700   0.3413   0.3432   0.3382
13: power    TRUE   FALSE FALSE 10   0.0144   0.0141   0.0157  -0.0033  -0.0036   0.0012
14: typeI    TRUE   FALSE FALSE 10   0.1803   0.1821   0.1736   0.3612   0.3628   0.3508
15: power    TRUE   FALSE FALSE  5   0.0234   0.0233   0.0243  -0.0010  -0.0010  -0.0028
16: typeI    TRUE   FALSE FALSE  5   0.1721   0.1720   0.1705   0.3455   0.3452   0.3416
17: power   FALSE    TRUE FALSE  5   0.0228   0.0228   0.0238  -0.0026  -0.0008  -0.0038
18: typeI   FALSE    TRUE FALSE  5  -0.0295  -0.0297  -0.0299   0.0044   0.0031   0.0035
#+end_example
#+LaTeX: \end{adjustwidth}
\Warning clear bias for non-binding scenarios under the null

\clearpage

* Distribution of the estimates

Distribution of the estimates:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Restrict to one observation per run, when we stop:
dt.estimate <- res2stage[decision %in% c("futility","efficacy"),]
## Distribution of the estimate:
gg.E <- ggplot(dt.estimate) + facet_grid(scenario~method.char)
gg.E <- gg.E + geom_density(alpha=0.25, aes(x = estimate_ML, fill = "Naive"))
gg.E <- gg.E + geom_density(alpha=0.25, aes(x = estimate_MUE, fill = "Median unbiased"))
gg.E <- gg.E + labs(fill = "Estimator", x = "Estimate", y = "Density")
gg.E <- gg.E + geom_vline(aes(xintercept = truth), color = "purple")
gg.E <- gg.E + theme(text = element_text(size=15), 
                     axis.line = element_line(linewidth = 1.25),
                     axis.ticks = element_line(linewidth = 2),
                     axis.ticks.length=unit(.25, "cm"),
                     legend.key.size = unit(3,"line"))

ggsave(gg.E, filename = file.path("report","figures","gg-estimate-density.pdf"), height = 10, width = 12)
ggsave(gg.E %+% dt.estimate[scenario == 1], filename = file.path("report","figures","gg-estimate-density-scenario1.pdf") )
#+END_SRC

#+RESULTS:

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Naive and Median unbiased estimate distribution over all simulations. Each row correspond to a different scenario
[[./figures/gg-estimate-density.pdf]]

#+ATTR_LaTeX: :width 0.8\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Same but specific to scenario 1
[[./figures/gg-estimate-density-scenario1.pdf]]

\clearpage

Distribution of the median unbiased estimate conditional to the stage:
#+BEGIN_SRC R :exports none :results output :session *R* :cache no
gg.estimateC <- ggplot(dt.estimate, aes(x = estimate_MUE, fill = stage.char, group = stage.char))
gg.estimateC <- gg.estimateC + geom_density(alpha=0.25) + facet_grid(scenario~method.char)
gg.estimateC <- gg.estimateC + labs(x = "estimate", fill = "stage", y = "Density")
gg.estimateC <- gg.estimateC + theme(text = element_text(size=15), 
                                     axis.line = element_line(linewidth = 1.25),
                                     axis.ticks = element_line(linewidth = 2),
                                     axis.ticks.length=unit(.25, "cm"),
                                     legend.key.size = unit(3,"line"))

ggsave(gg.estimateC, filename = file.path("report","figures","gg-estimateC-density.pdf"),
       height = 10, width = 12)
#+END_SRC

#+RESULTS:

#+ATTR_LaTeX: :width 1\textwidth :options trim={0 0 0 0} :placement [!h]
#+CAPTION: Median unbiased estimate distribution conditional to the stage. Each row correspond to a different scenario.
[[./figures/gg-estimateC-density.pdf]]

\clearpage

* Special cases

Reason for stopping (first 4) or continuing the trial (last):
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res2stage[scenario %in% 1:8,reason],
       method = res2stage[scenario %in% 1:8,method],
       scenario = res2stage[scenario %in% 1:8,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                              scenario    1    2    3    4    5    6    7    8
reason                 method                                                 
decreasing information 1                  0    0    1    1    0    0    0    0
                       2                  0    0    1    1    0    0    0    0
                       3                  0    0    1    1    0    0    0    0
efficacy               1               3740   77 3559   67 3696   82 3502   82
                       2               3729   82 3554   68 3732   82 3546   83
                       3               4137  107 3712   83 4071  110 3632   92
futility               1                646 7086  603 6922  600 7109  552 6901
                       2                658 7120  611 6904  542 6981  523 6834
                       3                560 6843  579 6822  495 6850  519 6812
Imax reached           1                  1    1    0    0    2    2    0    0
                       2                  1    1    0    0    2    2    0    0
                       3                  1    1    0    0    2    2    0    0
no boundary crossed    1               5613 2836 5838 3011 5702 2807 5946 3017
                       2               5612 2797 5835 3028 5724 2935 5931 3083
                       3               5302 3049 5709 3095 5432 3038 5849 3096
#+end_example

#+BEGIN_SRC R :exports results :results output :session *R* :cache no
ftable(reason = res2stage[scenario %in% 9:16,reason],
       method = res2stage[scenario %in% 9:16,method],
       scenario = res2stage[scenario %in% 9:16,scenario])
#+END_SRC

#+RESULTS:
#+begin_example
                              scenario    9   10   11   12   13   14   15   16
reason                 method                                                 
decreasing information 1                  0    0    1    0    0    0    0    0
                       2                  0    0    1    0    0    0    0    0
                       3                  0    0    1    0    0    0    0    0
efficacy               1               3805   84 3634   82 3815   78 3674   67
                       2               3824   81 3646   79 3816   78 3677   67
                       3               4206  109 3761   88 4238  112 3788   83
futility               1                614 7130  596 6957  604 7126  571 6920
                       2                572 7044  571 6907  628 7180  573 6925
                       3                535 6914  561 6867  514 6870  535 6837
Imax reached           1                  1    1    0    0    0    0    0    0
                       2                  1    1    0    0    0    0    0    0
                       3                  1    1    0    0    0    0    0    0
no boundary crossed    1               5580 2785 5770 2961 5581 2796 5755 3013
                       2               5603 2874 5783 3014 5556 2742 5750 3008
                       3               5258 2976 5678 3045 5248 3018 5677 3080
#+end_example

\clearpage

* Reversal probability

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
## Indicator of reversal
res2stage.reversal <- res2stage[, .(N = .N,
                                    futility2efficacy = (stage[1] == 1)*(reason[1] == "futility")*(stage[2] == 1)*(decision[2] == "efficacy"),
                                    efficacy2futility = (stage[1] == 1)*(reason[1] == "efficacy")*(stage[2] == 1)*(decision[2] == "futility")),
                                by = c("method","seed","missing","binding","fixC","ar","hypo")]
res2stage.reversal[is.na(futility2efficacy), futility2efficacy := 0]
res2stage.reversal[is.na(efficacy2futility), efficacy2futility := 0]
#+END_SRC

#+RESULTS:

Percentage of time we observe a reversal:
#+LaTeX: \begin{adjustwidth}{-1cm}{-1cm}
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stageS.reversal <- res2stage.reversal[, .(N = .N,
                                              fu2eff = 100*mean(futility2efficacy),
                                              eff2fu = 100*mean(efficacy2futility)),
                                          by = c("method","missing","binding","fixC","ar","hypo")]
tablePrint <- dcast(res2stageS.reversal, N + hypo + missing + ar + binding + fixC ~ method, value.var = c("fu2eff","eff2fu"))
print(tablePrint)
#+END_SRC

#+RESULTS:
#+begin_example
        N  hypo missing ar binding  fixC fu2eff_1 fu2eff_2 fu2eff_3 eff2fu_1 eff2fu_2 eff2fu_3
 1: 10000 power   FALSE  5    TRUE FALSE     0.06     0.07     0.01     0.04     0.04     0.63
 2: 10000 power    TRUE  5   FALSE FALSE     0.04     0.04     0.00     0.03     0.03     0.51
 3: 10000 power    TRUE  5   FALSE  TRUE     0.04     0.03     0.03     0.36     0.42     0.56
 4: 10000 power    TRUE  5    TRUE FALSE     0.06     0.08     0.02     0.05     0.07     0.65
 5: 10000 power    TRUE  5    TRUE  TRUE     0.02     0.02     0.01     0.36     0.42     0.63
 6: 10000 power    TRUE 10   FALSE FALSE     0.35     0.38     0.05     0.18     0.21     0.96
 7: 10000 power    TRUE 10   FALSE  TRUE     0.15     0.13     0.10     0.63     0.61     1.13
 8: 10000 power    TRUE 10    TRUE FALSE     0.57     0.57     0.13     0.15     0.20     1.06
 9: 10000 power    TRUE 10    TRUE  TRUE     0.17     0.16     0.11     0.70     0.68     0.99
10: 10000 typeI   FALSE  5    TRUE FALSE     0.01     0.03     0.00     0.01     0.03     0.12
11: 10000 typeI    TRUE  5   FALSE FALSE     0.00     0.00     0.00     0.00     0.01     0.08
12: 10000 typeI    TRUE  5   FALSE  TRUE     0.00     0.00     0.00     0.09     0.07     0.14
13: 10000 typeI    TRUE  5    TRUE FALSE     0.02     0.02     0.00     0.01     0.03     0.15
14: 10000 typeI    TRUE  5    TRUE  TRUE     0.00     0.00     0.00     0.10     0.12     0.14
15: 10000 typeI    TRUE 10   FALSE FALSE     0.00     0.00     0.00     0.09     0.09     0.31
16: 10000 typeI    TRUE 10   FALSE  TRUE     0.00     0.00     0.00     0.27     0.25     0.37
17: 10000 typeI    TRUE 10    TRUE FALSE     0.11     0.11     0.03     0.09     0.08     0.36
18: 10000 typeI    TRUE 10    TRUE  TRUE     0.02     0.00     0.00     0.22     0.21     0.39
#+end_example

#+LaTeX: \end{adjustwidth}


\clearpage

* Frequency mismatch p-value / boundaries

When concluding for futility:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.mismatchFU <- res2stage[decision=="futility",.(N = .N, mismatch = 100*mean(p.value_MUE<0.025)),
                                  by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res2stage.mismatchFU, hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC   method 1   method 2   method 3
 1: power   FALSE  5    TRUE FALSE 0.00000000 0.00000000 0.39860488
 2: power    TRUE  5   FALSE FALSE 0.41343669 0.41322314 0.46059365
 3: power    TRUE  5   FALSE  TRUE 1.92008303 2.29405631 0.41558442
 4: power    TRUE  5    TRUE FALSE 0.00000000 0.00000000 0.45477514
 5: power    TRUE  5    TRUE  TRUE 1.65000000 1.99590583 0.40160643
 6: power    TRUE 10   FALSE FALSE 2.43145370 2.47422680 0.93023256
 7: power    TRUE 10   FALSE  TRUE 5.23076923 4.75195822 1.15243583
 8: power    TRUE 10    TRUE FALSE 0.00000000 0.00000000 1.22762148
 9: power    TRUE 10    TRUE  TRUE 4.11094601 3.57325166 1.12187659
10: typeI   FALSE  5    TRUE FALSE 0.00000000 0.00000000 0.00000000
11: typeI    TRUE  5   FALSE FALSE 0.07037298 0.07047216 0.03428180
12: typeI    TRUE  5   FALSE  TRUE 0.31994312 0.24432810 0.03448276
13: typeI    TRUE  5    TRUE FALSE 0.00000000 0.00000000 0.02049180
14: typeI    TRUE  5    TRUE  TRUE 0.08198401 0.10244852 0.03076923
15: typeI    TRUE 10   FALSE FALSE 0.52930057 0.54012346 0.13869626
16: typeI    TRUE 10   FALSE  TRUE 0.75159714 0.69166363 0.00000000
17: typeI    TRUE 10    TRUE FALSE 0.00000000 0.00000000 0.04098361
18: typeI    TRUE 10    TRUE  TRUE 0.17391304 0.15345269 0.08200923
#+end_example

When concluding for efficacy:
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stage.mismatchEFF <- res2stage[decision=="efficacy",.(N = .N, mismatch = 100*mean(p.value_MUE>0.025)),
                                  by = c("method.char","missing","binding","fixC","ar","hypo")]
dcast(res2stage.mismatchEFF, hypo + missing + ar + binding + fixC ~ method.char, value.var = "mismatch")
#+END_SRC

#+RESULTS:
#+begin_example
     hypo missing ar binding  fixC method 1 method 2 method 3
 1: power   FALSE  5    TRUE FALSE        0        0        0
 2: power    TRUE  5   FALSE FALSE        0        0        0
 3: power    TRUE  5   FALSE  TRUE        0        0        0
 4: power    TRUE  5    TRUE FALSE        0        0        0
 5: power    TRUE  5    TRUE  TRUE        0        0        0
 6: power    TRUE 10   FALSE FALSE        0        0        0
 7: power    TRUE 10   FALSE  TRUE        0        0        0
 8: power    TRUE 10    TRUE FALSE        0        0        0
 9: power    TRUE 10    TRUE  TRUE        0        0        0
10: typeI   FALSE  5    TRUE FALSE        0        0        0
11: typeI    TRUE  5   FALSE FALSE        0        0        0
12: typeI    TRUE  5   FALSE  TRUE        0        0        0
13: typeI    TRUE  5    TRUE FALSE        0        0        0
14: typeI    TRUE  5    TRUE  TRUE        0        0        0
15: typeI    TRUE 10   FALSE FALSE        0        0        0
16: typeI    TRUE 10   FALSE  TRUE        0        0        0
17: typeI    TRUE 10    TRUE FALSE        0        0        0
18: typeI    TRUE 10    TRUE  TRUE        0        0        0
#+end_example

\clearpage

* Percentage of missing values

#+BEGIN_SRC R :exports none :results output :session *R* :cache no
res2stage.nXinterim <- res2stage[,.(N = .N, nX1 = unique(nX1.interim), nX2 = unique(nX2.interim), nX3 = unique(nX3.interim)),
                                 by = c("method","missing","ar","seed","binding","fixC","hypo")]
all(res2stage.nXinterim$N==3)

res2stageS.nXinterim <- res2stage.nXinterim[, .(N = .N,
                                                pc.all = 100*mean(nX3/nX1),
                                                pc.missing3 = 100*mean(nX2/nX1-nX3/nX1),
                                                pc.missing23 = 100*mean(1-nX2/nX1)),
                                            by = c("method","missing","ar","hypo","fixC","binding")]

setkeyv(res2stageS.nXinterim,"ar")
#+END_SRC

Here only for method 1 - values are very similar between different
methods:
- =pc.all= percentage of observations with full data
- =pc.missing3= percentage of observations missing the final outcome
  but with intermediate outcome value and baseline.
- =pc.missing23= percentage of observations with only baseline value
#+BEGIN_SRC R :exports results :results output :session *R* :cache no
res2stageS.nXinterim[method==1]
#+END_SRC

#+RESULTS:
#+begin_example
    method missing ar  hypo  fixC binding     N   pc.all pc.missing3 pc.missing23
 1:      1    TRUE  5 power FALSE    TRUE 10000 79.53472    9.562374    10.902910
 2:      1    TRUE  5 typeI FALSE    TRUE 10000 79.53472    9.562374    10.902910
 3:      1    TRUE  5 power  TRUE    TRUE 10000 79.44022    9.531225    11.028558
 4:      1    TRUE  5 typeI  TRUE    TRUE 10000 79.44022    9.531225    11.028558
 5:      1    TRUE  5 power  TRUE   FALSE 10000 79.71917    9.427430    10.853396
 6:      1    TRUE  5 typeI  TRUE   FALSE 10000 79.71917    9.427430    10.853396
 7:      1    TRUE  5 power FALSE   FALSE 10000 79.64196    9.449136    10.908902
 8:      1    TRUE  5 typeI FALSE   FALSE 10000 79.64196    9.449136    10.908902
 9:      1   FALSE  5 power FALSE    TRUE 10000 87.78863    6.090240     6.121126
10:      1   FALSE  5 typeI FALSE    TRUE 10000 87.78863    6.090240     6.121126
11:      1    TRUE 10 power FALSE    TRUE 10000 71.60971   13.327969    15.062319
12:      1    TRUE 10 typeI FALSE    TRUE 10000 71.60971   13.327969    15.062319
13:      1    TRUE 10 power  TRUE    TRUE 10000 71.52189   13.282615    15.195496
14:      1    TRUE 10 typeI  TRUE    TRUE 10000 71.52189   13.282615    15.195496
15:      1    TRUE 10 power  TRUE   FALSE 10000 71.85935   13.144488    14.996166
16:      1    TRUE 10 typeI  TRUE   FALSE 10000 71.85935   13.144488    14.996166
17:      1    TRUE 10 power FALSE   FALSE 10000 71.79364   13.168843    15.037522
18:      1    TRUE 10 typeI FALSE   FALSE 10000 71.79364   13.168843    15.037522
#+end_example

# @@latex:any arbitrary LaTeX code@@

* CONFIG :noexport:
# #+LaTeX_HEADER:\affil{Department of Biostatistics, University of Copenhagen, Copenhagen, Denmark}
#+LANGUAGE:  en
#+LaTeX_CLASS: org-article
#+LaTeX_CLASS_OPTIONS: [12pt]
#+OPTIONS:   title:t author:t toc:nil todo:nil
#+OPTIONS:   H:3 num:t 
#+OPTIONS:   TeX:t LaTeX:t
#+LATEX_HEADER: %
#+LATEX_HEADER: %%%% specifications %%%%
#+LATEX_HEADER: %
** Latex command
#+LATEX_HEADER: \usepackage{ifthen}
#+LATEX_HEADER: \usepackage{xifthen}
#+LATEX_HEADER: \usepackage{xargs}
#+LATEX_HEADER: \usepackage{xspace}
#+LATEX_HEADER: \newcommand\Rlogo{\textbf{\textsf{R}}\xspace} % 
** Notations

** Code
# Documentation at https://org-babel.readthedocs.io/en/latest/header-args/#results
# :tangle (yes/no/filename) extract source code with org-babel-tangle-file, see http://orgmode.org/manual/Extracting-source-code.html 
# :cache (yes/no)
# :eval (yes/no/never)
# :results (value/output/silent/graphics/raw/latex)
# :export (code/results/none/both)
#+PROPERTY: header-args :session *R* :tangle yes :cache no ## extra argument need to be on the same line as :session *R*
# Code display:
#+LATEX_HEADER: \RequirePackage{fancyvrb}
#+LATEX_HEADER: \DefineVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\small,formatcom = {\color[rgb]{0.5,0,0}}}
# ## change font size input
# ## #+ATTR_LATEX: :options basicstyle=\ttfamily\scriptsize
# ## change font size output
# ## \RecustomVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\tiny,formatcom = {\color[rgb]{0.5,0,0}}}
** Display 
#+LATEX_HEADER: \RequirePackage{colortbl} % arrayrulecolor to mix colors
#+LATEX_HEADER: \RequirePackage{setspace} % to modify the space between lines - incompatible with footnote in beamer
#+LaTeX_HEADER:\renewcommand{\baselinestretch}{1.1}
#+LATEX_HEADER:\geometry{top=1cm}
#+LATEX_HEADER: \RequirePackage{changepage}

#+LATEX_HEADER: \RequirePackage{colortbl} % arrayrulecolor to mix colors
# ## valid and cross symbols
#+LaTeX_HEADER: \RequirePackage{pifont}
#+LaTeX_HEADER: \RequirePackage{relsize}
#+LaTeX_HEADER: \newcommand{\Cross}{{\raisebox{-0.5ex}%
#+LaTeX_HEADER:		{\relsize{1.5}\ding{56}}}\hspace{1pt} }
#+LaTeX_HEADER: \newcommand{\Valid}{{\raisebox{-0.5ex}%
#+LaTeX_HEADER:		{\relsize{1.5}\ding{52}}}\hspace{1pt} }
#+LaTeX_HEADER: \newcommand{\CrossR}{ \textcolor{red}{\Cross} }
#+LaTeX_HEADER: \newcommand{\ValidV}{ \textcolor{green}{\Valid} }
# ## warning symbol
#+LaTeX_HEADER: \usepackage{stackengine}
#+LaTeX_HEADER: \usepackage{scalerel}
#+LaTeX_HEADER: \newcommand\Warning[1][3ex]{%
#+LaTeX_HEADER:   \renewcommand\stacktype{L}%
#+LaTeX_HEADER:   \scaleto{\stackon[1.3pt]{\color{red}$\triangle$}{\tiny\bfseries !}}{#1}%
#+LaTeX_HEADER:   \xspace
#+LaTeX_HEADER: }
# # change the color of the links
#+LaTeX_HEADER: \hypersetup{
#+LaTeX_HEADER:  citecolor=[rgb]{0,0.5,0},
#+LaTeX_HEADER:  urlcolor=[rgb]{0,0,0.5},
#+LaTeX_HEADER:  linkcolor=[rgb]{0,0,0.5},
#+LaTeX_HEADER: }
** Image
#+LATEX_HEADER: \RequirePackage{epstopdf} % to be able to convert .eps to .pdf image files
#+LATEX_HEADER: \RequirePackage{capt-of} % 
#+LATEX_HEADER: \RequirePackage{caption} % newlines in graphics
** List
#+LATEX_HEADER: \RequirePackage{enumitem} % to be able to convert .eps to .pdf image files
** Color
#+LaTeX_HEADER: \definecolor{light}{rgb}{1, 1, 0.9}
#+LaTeX_HEADER: \definecolor{lightred}{rgb}{1.0, 0.7, 0.7}
#+LaTeX_HEADER: \definecolor{lightblue}{rgb}{0.0, 0.8, 0.8}
#+LaTeX_HEADER: \newcommand{\darkblue}{blue!80!black}
#+LaTeX_HEADER: \newcommand{\darkgreen}{green!50!black}
#+LaTeX_HEADER: \newcommand{\darkred}{red!50!black}
** Box
#+LATEX_HEADER: \usepackage{mdframed}
** Shortcut
#+LATEX_HEADER: \newcommand{\first}{1\textsuperscript{st} }
#+LATEX_HEADER: \newcommand{\second}{2\textsuperscript{nd} }
#+LATEX_HEADER: \newcommand{\third}{3\textsuperscript{rd} }
